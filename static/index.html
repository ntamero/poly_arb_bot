<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PolyARB ¬∑ Trading Terminal</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  /* Background ‚Äî deep dark neutral */
  --bg:#09090f;--bg2:#0f0f18;--bg3:#141420;--bg4:#1a1a28;--surface:#20202e;
  --border:#252535;--border2:#303048;
  --text:#f2f0ff;--text2:#8b889e;--text3:#454360;

  /* Ana renkler ‚Äî mavi/lacivert YOK */
  --green:#39e8a8;--green2:#22c97e;--gdim:rgba(57,232,168,.12);--gglow:rgba(57,232,168,.35);
  --red:#ff4d6a;--red2:#e02040;--rdim:rgba(255,77,106,.12);--rglow:rgba(255,77,106,.3);
  --gold:#f5c842;--gdold:rgba(245,200,66,.12);--ggold:rgba(245,200,66,.3);
  --amber:#ff9a3c;--adim:rgba(255,154,60,.12);
  --violet:#c084fc;--vdim:rgba(192,132,252,.12);--vglow:rgba(192,132,252,.3);
  --rose:#fb7185;--rdose:rgba(251,113,133,.12);
  --teal:#2dd4bf;--tdim:rgba(45,212,191,.12);

  /* Accent (active tab, links etc) ‚Äî green-teal */
  --blue:var(--teal);--bdim:var(--tdim);--bglow:var(--gglow);
  --purple:var(--violet);--pdim:var(--vdim);

  --mono:'JetBrains Mono',monospace;--sans:'Space Grotesk',sans-serif;
  --r4:4px;--r8:8px;--r12:12px;--r16:16px;
}

html,body{height:100%;overflow:hidden}
body{background:var(--bg);color:var(--text);font-family:var(--sans);font-size:13px}

/* SCROLLBAR */
::-webkit-scrollbar{width:3px;height:3px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}

/* ‚ïê‚ïê‚ïê TOPBAR ‚ïê‚ïê‚ïê */
.topbar{
  height:56px;background:var(--bg2);border-bottom:1px solid var(--border);
  display:flex;align-items:center;padding:0 20px;gap:0;flex-shrink:0;
  position:relative;z-index:100;
}
.logo{display:flex;align-items:center;gap:10px;margin-right:28px}
.logo-mark{
  width:34px;height:34px;border-radius:var(--r8);
  background:linear-gradient(135deg,#39e8a8 0%,#f5c842 100%);
  display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0;
  box-shadow:0 0 20px rgba(57,232,168,.35);
}
.logo-text{font-family:var(--mono);font-size:13px;font-weight:700;letter-spacing:.08em}
.logo-sub{font-size:9px;color:var(--text3);letter-spacing:.1em;margin-top:1px}
.tb-metrics{display:flex;align-items:center;gap:0;flex:1}
.tb-metric{
  padding:0 24px;border-right:1px solid var(--border);
  display:flex;flex-direction:column;align-items:center;
}
.tb-metric:first-child{padding-left:0}
.tb-val{font-family:var(--mono);font-size:16px;font-weight:700;line-height:1;letter-spacing:-.01em}
.tb-key{font-size:9px;color:var(--text3);margin-top:3px;letter-spacing:.08em;text-transform:uppercase}
.tb-right{display:flex;align-items:center;gap:10px}
.ws-pill{
  display:flex;align-items:center;gap:5px;
  font-family:var(--mono);font-size:10px;font-weight:600;letter-spacing:.05em;
  padding:5px 12px;border-radius:20px;border:1px solid var(--border2);
  background:var(--bg3);color:var(--text2);transition:all .4s;cursor:default;
}
.ws-pill .dot{width:6px;height:6px;border-radius:50%;background:var(--text3);transition:all .4s}
.ws-pill.live{border-color:rgba(45,212,191,.5);color:var(--teal);background:var(--tdim)}
.ws-pill.live .dot{background:var(--green);box-shadow:0 0 8px var(--gglow);animation:pulse 2s ease infinite}
.ws-pill.err{border-color:rgba(255,61,90,.5);color:var(--red);background:var(--rdim)}
.ws-pill.err .dot{background:var(--red)}
@keyframes pulse{0%,100%{opacity:1;box-shadow:0 0 8px var(--gglow)}50%{opacity:.5;box-shadow:0 0 4px var(--gglow)}}
.clock{font-family:var(--mono);font-size:12px;color:var(--text2);letter-spacing:.05em;min-width:64px;text-align:right}

/* ‚ïê‚ïê‚ïê LAYOUT ‚ïê‚ïê‚ïê */
.app{display:flex;flex:1;overflow:hidden;height:calc(100vh - 56px)}

/* LEFT SIDEBAR */
.sidebar{width:264px;flex-shrink:0;background:var(--bg2);border-right:1px solid var(--border);overflow-y:auto;display:flex;flex-direction:column;gap:0}

/* MAIN */
.main-area{flex:1;display:flex;flex-direction:column;overflow:hidden;background:var(--bg)}

/* DAILY STRIP */
.daily-strip{
  display:grid;grid-template-columns:repeat(5,1fr);
  border-bottom:1px solid var(--border);flex-shrink:0;
}
.ds-item{
  padding:10px 16px;border-right:1px solid var(--border);
  display:flex;flex-direction:column;gap:3px;
  position:relative;overflow:hidden;
}
.ds-item:last-child{border-right:none}
.ds-item::before{
  content:'';position:absolute;bottom:0;left:0;right:0;height:2px;
  opacity:.5;transition:opacity .3s;
}
.ds-item:hover::before{opacity:1}
.ds-item:nth-child(1)::before{background:var(--teal)}
.ds-item:nth-child(2)::before{background:linear-gradient(90deg,var(--green),var(--amber))}
.ds-item:nth-child(3)::before{background:var(--green)}
.ds-item:nth-child(4)::before{background:var(--red)}
.ds-item:nth-child(5)::before{background:var(--violet)}
.ds-val{font-family:var(--mono);font-size:17px;font-weight:700;line-height:1;letter-spacing:-.02em}
.ds-key{font-size:9px;color:var(--text3);letter-spacing:.08em;text-transform:uppercase}

/* TABS */
.tab-strip{
  display:flex;align-items:center;gap:1px;
  padding:8px 16px 0;border-bottom:1px solid var(--border);
  background:var(--bg2);flex-shrink:0;
}
.tab{
  padding:8px 18px;font-family:var(--mono);font-size:10px;font-weight:600;letter-spacing:.06em;
  color:var(--text3);cursor:pointer;border:none;background:none;
  border-bottom:2px solid transparent;margin-bottom:-1px;transition:all .2s;
  display:flex;align-items:center;gap:7px;
}
.tab:hover{color:var(--text2)}
.tab.active{color:var(--text);border-bottom-color:var(--teal)}
.tab-badge{
  font-size:9px;padding:1px 6px;border-radius:9px;
  background:var(--surface);color:var(--text2);transition:all .2s;
}
.tab.active .tab-badge{background:var(--tdim);color:var(--teal)}

/* PANELS */
.panels{flex:1;overflow:hidden;position:relative}
.panel{position:absolute;inset:0;overflow-y:auto;overflow-x:hidden;padding:16px;display:none;flex-direction:column;gap:14px}
.panel.active{display:flex}
/* Chart panelindeki her child shrink etmesin */
#panel-chart > *{flex-shrink:0}

/* RIGHT PANEL */
.right-rail{
  width:340px;flex-shrink:0;background:var(--bg2);
  border-left:1px solid var(--border);overflow-y:auto;
  display:flex;flex-direction:column;
}
.rail-section{border-bottom:1px solid var(--border)}
.rail-hdr{
  padding:10px 14px;display:flex;align-items:center;justify-content:space-between;
  background:var(--bg3);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10;
}
.rail-hdr-title{font-family:var(--mono);font-size:10px;font-weight:700;letter-spacing:.1em;color:var(--text2)}
.rail-badge{font-family:var(--mono);font-size:10px;padding:2px 8px;border-radius:9px}
.rail-badge.open{background:var(--tdim);color:var(--teal);border:1px solid rgba(45,212,191,.3)}
.rail-badge.closed{background:var(--surface);color:var(--text2)}

/* ‚îÄ‚îÄ‚îÄ SIDEBAR MODULES ‚îÄ‚îÄ‚îÄ */
.sb-section{padding:14px;border-bottom:1px solid var(--border)}
.sb-label{font-family:var(--mono);font-size:9px;font-weight:700;letter-spacing:.12em;color:var(--text3);text-transform:uppercase;margin-bottom:10px}

/* Balance */
.bal-card{
  background:linear-gradient(135deg,var(--bg4) 0%,var(--bg3) 100%);
  border:1px solid var(--border2);border-radius:var(--r12);padding:14px;
  position:relative;overflow:hidden;
}
.bal-card::after{
  content:'';position:absolute;top:-30px;right:-30px;
  width:100px;height:100px;border-radius:50%;
  background:radial-gradient(circle,rgba(45,212,191,.1) 0%,transparent 70%);
}
.bal-amount{
  font-family:var(--mono);font-size:28px;font-weight:700;letter-spacing:-.03em;
  background:linear-gradient(135deg,var(--text) 60%,var(--text2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  line-height:1;
}
.bal-label{font-size:10px;color:var(--text3);margin-top:4px;margin-bottom:12px}
.bal-row{display:flex;gap:6px}
.bal-stat{flex:1;background:rgba(0,0,0,.3);border-radius:var(--r8);padding:8px;border:1px solid var(--border)}
.bal-stat-val{font-family:var(--mono);font-size:12px;font-weight:700;line-height:1}
.bal-stat-key{font-size:9px;color:var(--text3);margin-top:3px}

/* Win Rate */
.wr-wrap{display:flex;align-items:center;gap:12px}
.wr-donut{position:relative;width:76px;height:76px;flex-shrink:0}
.wr-donut svg{transform:rotate(-90deg)}
.wr-track{fill:none;stroke:var(--border2);stroke-width:7}
.wr-arc{fill:none;stroke-width:7;stroke-linecap:round;transition:stroke-dashoffset .8s cubic-bezier(.4,0,.2,1),stroke .4s}
.wr-center{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.wr-num{font-family:var(--mono);font-size:16px;font-weight:800;line-height:1;transition:color .4s}
.wr-micro{font-size:8px;color:var(--text3);margin-top:1px}
.wr-list{flex:1;display:flex;flex-direction:column;gap:6px}
.wr-row{display:flex;justify-content:space-between;align-items:center}
.wr-row-key{font-size:11px;color:var(--text2)}
.wr-row-val{font-family:var(--mono);font-size:12px;font-weight:700}
.wr-bar-wrap{height:3px;background:var(--border);border-radius:2px;margin-top:-2px;overflow:hidden}
.wr-bar-fill{height:100%;border-radius:2px;transition:width .6s}

/* BTC Ticker */
.btc-price-main{font-family:var(--mono);font-size:20px;font-weight:700;color:var(--gold);letter-spacing:-.02em;line-height:1}
.btc-sub{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.btc-avg-label{font-size:10px;color:var(--text3)}
.btc-spread-val{font-family:var(--mono);font-size:11px;color:var(--text2)}
.btc-canvas{margin:6px 0}
.btc-ex-row{
  display:flex;justify-content:space-between;align-items:center;
  padding:5px 0;border-top:1px solid var(--border);
}
.btc-ex-name{font-family:var(--mono);font-size:9px;color:var(--text3);letter-spacing:.06em;width:65px}
.btc-ex-price{font-family:var(--mono);font-size:11px;font-weight:600}
.btc-ex-delta{font-family:var(--mono);font-size:10px;text-align:right;width:46px}

/* AutoTrader */
.auto-card{background:var(--bg3);border:1px solid var(--border);border-radius:var(--r12);overflow:hidden}
.auto-head{
  padding:11px 14px;background:linear-gradient(135deg,var(--bg4),var(--bg3));
  border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;
}
.auto-head-title{font-weight:700;font-size:13px;display:flex;align-items:center;gap:6px}
.status-dot{width:8px;height:8px;border-radius:50%;background:var(--text3);transition:all .3s}
.status-dot.on{background:var(--green);box-shadow:0 0 10px var(--gglow);animation:pulse 2s infinite}
.status-label{font-family:var(--mono);font-size:10px;font-weight:700;letter-spacing:.06em}
.status-label.on{color:var(--green)}.status-label.off{color:var(--text3)}
.auto-body{padding:12px 14px}
.auto-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:10px}
.ag-cell{background:var(--bg4);border-radius:var(--r8);padding:8px 10px;border:1px solid var(--border)}
.ag-val{font-family:var(--mono);font-size:15px;font-weight:700;color:var(--amber);line-height:1}
.ag-key{font-size:9px;color:var(--text3);margin-top:3px;letter-spacing:.04em}
.scan-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;font-size:10px;color:var(--text3)}
.scan-time{font-family:var(--mono);color:var(--text2)}
.prog-track{height:3px;background:var(--border);border-radius:2px;overflow:hidden;margin-bottom:10px}
.prog-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--amber),var(--violet));transition:width 1s linear}
.cfg-row{display:flex;gap:6px;align-items:center;margin-bottom:8px}
.cfg-lbl{font-size:9px;color:var(--text3);white-space:nowrap;letter-spacing:.04em}
.cfg-inp{
  background:var(--bg4);border:1px solid var(--border2);border-radius:var(--r4);
  color:var(--text);font-family:var(--mono);font-size:11px;
  padding:4px 8px;width:66px;outline:none;transition:border-color .2s;
}
.cfg-inp:focus{border-color:var(--teal)}
.btn-row{display:flex;gap:6px}
.btn{
  flex:1;padding:8px 10px;border-radius:var(--r8);
  font-family:var(--mono);font-size:11px;font-weight:700;letter-spacing:.04em;
  border:none;cursor:pointer;transition:all .15s;
}
.btn-go{background:linear-gradient(135deg,#1a5c32,#217a3e);color:#fff}
.btn-go:hover{background:linear-gradient(135deg,#217a3e,#00b87a);box-shadow:0 0 16px rgba(0,184,122,.3)}
.btn-halt{background:var(--rdim);color:var(--red);border:1px solid rgba(255,61,90,.3)}
.btn-halt:hover{background:rgba(255,61,90,.2)}
.btn-scan{background:var(--adim);color:var(--amber);border:1px solid rgba(255,154,60,.3)}
.btn-scan:hover{background:rgba(255,154,60,.2)}
.btn-reset{background:rgba(0,0,0,.3);color:var(--text3);border:1px solid var(--border);font-size:10px;flex:none;padding:8px 12px}
.btn-reset:hover{border-color:var(--red);color:var(--red)}

/* ‚îÄ‚îÄ‚îÄ CHART PANEL ‚îÄ‚îÄ‚îÄ */
.kpi-strip{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;flex-shrink:0}
.kpi{
  background:var(--bg3);border:1px solid var(--border);border-radius:var(--r12);
  padding:12px 14px;text-align:center;position:relative;overflow:hidden;
  transition:border-color .2s,transform .2s;cursor:default;
}
.kpi:hover{border-color:var(--border2);transform:translateY(-1px)}
.kpi::after{
  content:'';position:absolute;bottom:0;left:0;right:0;height:2px;
  transition:opacity .3s;opacity:.4;
}
.kpi:hover::after{opacity:1}
.kpi:nth-child(1)::after{background:var(--teal)}
.kpi:nth-child(2)::after{background:linear-gradient(90deg,var(--green),var(--amber))}
.kpi:nth-child(3)::after{background:var(--green)}
.kpi:nth-child(4)::after{background:var(--blue)}
.kpi:nth-child(5)::after{background:var(--gold)}
.kpi:nth-child(6)::after{background:var(--purple)}
.kpi-val{font-family:var(--mono);font-size:18px;font-weight:800;line-height:1;letter-spacing:-.02em}
.kpi-key{font-size:9px;color:var(--text3);margin-top:5px;letter-spacing:.08em;text-transform:uppercase}

.chart-card{
  background:var(--bg3);border:1px solid var(--border);border-radius:var(--r12);
  padding:18px 18px 14px;flex-shrink:0;
}
.chart-wrap{position:relative;height:220px;width:100%}
.sub-chart-wrap{position:relative;height:150px;width:100%}
.chart-card-hdr{
  display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;
}
.chart-card-title{font-family:var(--mono);font-size:11px;font-weight:700;color:var(--text2);letter-spacing:.08em}
.period-row{display:flex;gap:3px}
.pbtn{
  font-family:var(--mono);font-size:9px;font-weight:600;letter-spacing:.06em;
  padding:4px 9px;border-radius:var(--r4);
  border:1px solid var(--border2);background:var(--bg4);color:var(--text3);
  cursor:pointer;transition:all .15s;
}
.pbtn:hover,.pbtn.active{border-color:rgba(45,212,191,.5);color:var(--teal);background:var(--tdim)}

.sub-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;flex-shrink:0}
.sub-chart-card{background:var(--bg3);border:1px solid var(--border);border-radius:var(--r12);padding:14px;flex-shrink:0}
.sub-chart-title{font-family:var(--mono);font-size:9px;font-weight:700;letter-spacing:.1em;color:var(--text3);margin-bottom:10px;text-transform:uppercase}

/* ‚îÄ‚îÄ‚îÄ POSITION CARDS (right rail) ‚îÄ‚îÄ‚îÄ */
.pos-list{padding:8px;display:flex;flex-direction:column;gap:6px}
.pos-card{
  background:var(--bg3);border:1px solid var(--border);border-radius:var(--r12);
  overflow:hidden;transition:all .25s;position:relative;
  cursor:default;
}
.pos-card:hover{border-color:var(--border2);box-shadow:0 8px 32px rgba(0,0,0,.5);transform:translateY(-1px)}
.pos-card.resolving{animation:resolvePulse .6s ease}
@keyframes resolvePulse{
  0%{box-shadow:0 0 0 0 rgba(0,229,160,.5)}
  70%{box-shadow:0 0 0 12px rgba(0,229,160,0)}
  100%{box-shadow:0 0 0 0 rgba(0,229,160,0)}
}
.pos-card.slide-out{animation:slideAway .4s cubic-bezier(.4,0,1,1) forwards}
@keyframes slideAway{to{opacity:0;transform:translateX(40px) scale(.95);max-height:0;padding:0;margin:0}}
.pos-card.win-flash{animation:winFlash .8s ease}
@keyframes winFlash{0%,100%{border-color:var(--border)}50%{border-color:var(--green);box-shadow:0 0 20px var(--gdim)}}

.pos-top{padding:10px 12px;display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
.pos-mkt{font-size:11px;font-weight:600;color:var(--text);line-height:1.4;flex:1}
.pos-tags{display:flex;flex-direction:column;align-items:flex-end;gap:3px;flex-shrink:0}

.tag{display:inline-block;padding:2px 7px;border-radius:var(--r4);font-family:var(--mono);font-size:9px;font-weight:700;letter-spacing:.05em;text-transform:uppercase}
.tg-yes{background:var(--gdim);color:var(--green);border:1px solid rgba(0,229,160,.25)}
.tg-no{background:var(--rdim);color:var(--red);border:1px solid rgba(255,61,90,.25)}
.tg-btc{background:var(--gdold);color:var(--gold);border:1px solid rgba(255,204,68,.25)}
.tg-metals{background:var(--pdim);color:var(--purple);border:1px solid rgba(176,110,251,.25)}
.tg-weather{background:var(--tdim);color:var(--teal);border:1px solid rgba(45,212,191,.25)}
.tg-won{background:var(--gdim);color:var(--green)}
.tg-lost{background:var(--rdim);color:var(--red)}
.tg-open{background:var(--tdim);color:var(--teal)}

.pos-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:4px;padding:0 12px 8px}
.ps{background:var(--bg4);border-radius:6px;padding:6px 7px;border:1px solid var(--border)}
.ps-val{font-family:var(--mono);font-size:11px;font-weight:700;line-height:1}
.ps-key{font-size:8px;color:var(--text3);margin-top:2px;letter-spacing:.04em}

.pos-live{
  display:flex;align-items:center;justify-content:space-between;
  margin:0 12px 8px;padding:6px 10px;
  background:var(--bg4);border-radius:var(--r8);border:1px solid var(--border);
}
.pos-live-lbl{font-size:10px;color:var(--text3)}
.pos-live-price{font-family:var(--mono);font-size:14px;font-weight:800;transition:color .3s}
.pos-live-price.tick-up{color:var(--green);animation:tickUp .4s ease}
.pos-live-price.tick-down{color:var(--red);animation:tickDown .4s ease}
@keyframes tickUp{0%{transform:translateY(-3px)}100%{transform:translateY(0)}}
@keyframes tickDown{0%{transform:translateY(3px)}100%{transform:translateY(0)}}
.pos-upnl{font-family:var(--mono);font-size:12px;font-weight:700}

.pos-prog{height:3px;margin:0 12px 8px;border-radius:2px;background:var(--border);overflow:hidden}
.pos-prog-fill{height:100%;border-radius:2px;transition:width .5s,background .5s}

.pos-foot{display:flex;gap:5px;padding:0 12px 10px}
.pf-btn{
  flex:1;padding:6px;border-radius:6px;font-family:var(--mono);font-size:10px;font-weight:700;
  border:1px solid var(--border2);background:var(--bg4);color:var(--text2);
  cursor:pointer;transition:all .15s;
}
.pf-btn:hover{background:var(--surface)}
.pf-btn.yes:hover{border-color:rgba(0,229,160,.5);color:var(--green);background:var(--gdim)}
.pf-btn.no:hover{border-color:rgba(255,61,90,.5);color:var(--red);background:var(--rdim)}

/* Hover detail overlay */
.pos-card .pos-hover-detail{
  max-height:0;overflow:hidden;transition:max-height .3s ease;
  border-top:0px solid var(--border);
}
.pos-card:hover .pos-hover-detail{max-height:80px;border-top:1px solid var(--border)}
.phd-inner{padding:8px 12px;display:flex;justify-content:space-between;font-size:10px;color:var(--text3)}
.phd-item{display:flex;flex-direction:column;align-items:center;gap:2px}
.phd-val{font-family:var(--mono);font-size:11px;color:var(--text2);font-weight:600}

/* CLOSED list */
.closed-list{padding:8px;display:flex;flex-direction:column;gap:4px}
.closed-card{
  background:var(--bg3);border:1px solid var(--border);border-radius:var(--r8);
  padding:9px 12px;display:flex;align-items:center;gap:10px;
  transition:all .2s;cursor:default;
}
.closed-card:hover{border-color:var(--border2)}
.closed-card.w{border-left:3px solid var(--green)}
.closed-card.l{border-left:3px solid var(--red)}
.closed-main{flex:1;min-width:0}
.closed-mkt{font-size:11px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.closed-meta{display:flex;gap:6px;margin-top:3px;align-items:center}
.closed-pnl{font-family:var(--mono);font-size:14px;font-weight:800;flex-shrink:0}
.closed-card.fade-in{animation:fadeIn .4s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}

/* ‚îÄ‚îÄ‚îÄ OPPORTUNITIES TABLE ‚îÄ‚îÄ‚îÄ */
.opp-table-wrap{background:var(--bg3);border:1px solid var(--border);border-radius:var(--r12);overflow:hidden}
.opp-table{width:100%;border-collapse:collapse;font-family:var(--mono);font-size:11px}
.opp-table thead th{
  padding:9px 12px;text-align:left;color:var(--text3);font-weight:600;font-size:9px;letter-spacing:.1em;text-transform:uppercase;
  border-bottom:1px solid var(--border);background:var(--bg4);
  position:sticky;top:0;z-index:10;
}
.opp-table tbody tr{border-bottom:1px solid var(--border);transition:background .1s}
.opp-table tbody tr:last-child{border-bottom:none}
.opp-table tbody tr:hover{background:rgba(255,255,255,.025)}
.opp-table td{padding:9px 12px;vertical-align:middle}
.opp-mkt{max-width:240px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--text);font-size:11px}
.eh{color:var(--green);font-weight:800}
.em{color:var(--gold);font-weight:700}
.el{color:var(--text2)}
.en{color:var(--red)}
.bet-btn{
  font-family:var(--mono);font-size:9px;font-weight:700;letter-spacing:.06em;
  padding:4px 10px;border-radius:var(--r4);
  border:1px solid rgba(45,212,191,.3);background:var(--tdim);color:var(--teal);
  cursor:pointer;transition:all .15s;
}
.bet-btn:hover{background:rgba(45,212,191,.2);border-color:var(--teal)}

/* ‚îÄ‚îÄ‚îÄ HISTORY TABLE ‚îÄ‚îÄ‚îÄ */
.hist-table-wrap{background:var(--bg3);border:1px solid var(--border);border-radius:var(--r12);overflow:hidden}
.hist-table{width:100%;border-collapse:collapse;font-family:var(--mono);font-size:11px}
.hist-table thead th{
  padding:9px 12px;text-align:left;color:var(--text3);font-weight:600;font-size:9px;letter-spacing:.1em;text-transform:uppercase;
  border-bottom:1px solid var(--border);background:var(--bg4);
  position:sticky;top:0;z-index:10;
}
.hist-table tbody tr{border-bottom:1px solid var(--border);transition:background .1s}
.hist-table tbody tr:last-child{border-bottom:none}
.hist-table tbody tr:hover{background:rgba(255,255,255,.025)}
.hist-table td{padding:9px 12px;vertical-align:middle}

/* ‚îÄ‚îÄ‚îÄ LOG ‚îÄ‚îÄ‚îÄ */
.log-wrap{background:var(--bg3);border:1px solid var(--border);border-radius:var(--r12);overflow:hidden;flex:1;display:flex;flex-direction:column}
.log-hdr{padding:9px 14px;border-bottom:1px solid var(--border);background:var(--bg4);display:flex;justify-content:space-between;align-items:center}
.log-hdr-title{font-family:var(--mono);font-size:10px;font-weight:700;letter-spacing:.08em;color:var(--text2)}
.log-feed{
  flex:1;overflow-y:auto;padding:6px;font-family:var(--mono);font-size:10px;
  display:flex;flex-direction:column-reverse;gap:2px;min-height:300px;max-height:600px;
  background:var(--bg);
}
.log-line{padding:4px 8px;border-radius:var(--r4);line-height:1.6;border-left:2px solid var(--border2);color:var(--text2)}
.log-line.s{border-left-color:var(--green);color:var(--green)}
.log-line.w{border-left-color:var(--gold);color:var(--gold)}
.log-line.e{border-left-color:var(--red);color:var(--red)}
.log-ts{color:var(--text3);margin-right:7px}

/* UTILS */
.empty{padding:36px;text-align:center;color:var(--text3);font-family:var(--mono);font-size:11px}
.spin{display:inline-block;width:10px;height:10px;border:2px solid var(--border2);border-top-color:var(--blue);border-radius:50%;animation:spin .6s linear infinite;margin-right:4px;vertical-align:middle}
@keyframes spin{to{transform:rotate(360deg)}}
.g{color:var(--green)}.r{color:var(--red)}.y{color:var(--gold)}.b{color:var(--blue)}.p{color:var(--purple)}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TOPBAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<header class="topbar">
  <div class="logo">
    <div class="logo-mark">‚ö°</div>
    <div>
      <div class="logo-text">POLYARB</div>
      <div class="logo-sub">TRADING TERMINAL</div>
    </div>
  </div>

  <div class="tb-metrics">
    <div class="tb-metric">
      <div class="tb-val" style="color:var(--teal)" id="tb_bal">$‚Äî</div>
      <div class="tb-key">BALANCE</div>
    </div>
    <div class="tb-metric">
      <div class="tb-val" id="tb_pnl">$‚Äî</div>
      <div class="tb-key">DAILY P&amp;L</div>
    </div>
    <div class="tb-metric">
      <div class="tb-val" style="color:var(--amber)" id="tb_open">‚Äî</div>
      <div class="tb-key">OPEN POS.</div>
    </div>
    <div class="tb-metric">
      <div class="tb-val y" id="tb_btc">$‚Äî</div>
      <div class="tb-key">BTC</div>
    </div>
    <div class="tb-metric">
      <div class="tb-val" id="tb_wr">‚Äî%</div>
      <div class="tb-key">WIN RATE</div>
    </div>
  </div>

  <div class="tb-right">
    <div class="ws-pill" id="wsPill"><div class="dot"></div><span id="wsLbl">CONNECTING</span></div>
    <div class="clock" id="clockEl">‚Äî</div>
  </div>
</header>

<div class="app">

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LEFT SIDEBAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<aside class="sidebar">

  <!-- Balance -->
  <div class="sb-section">
    <div class="sb-label">Portfolio</div>
    <div class="bal-card">
      <div class="bal-amount" id="sb_bal">$0.00</div>
      <div class="bal-label">Total Balance</div>
      <div class="bal-row">
        <div class="bal-stat">
          <div class="bal-stat-val g" id="sb_real">$0</div>
          <div class="bal-stat-key">REALIZED</div>
        </div>
        <div class="bal-stat">
          <div class="bal-stat-val" style="color:var(--teal)" id="sb_unreal">$0</div>
          <div class="bal-stat-key">UNREALIZED</div>
        </div>
        <div class="bal-stat">
          <div class="bal-stat-val y" id="sb_inv">$0</div>
          <div class="bal-stat-key">INVESTED</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Win Rate -->
  <div class="sb-section">
    <div class="sb-label">Win Rate</div>
    <div class="wr-wrap">
      <div class="wr-donut">
        <svg viewBox="0 0 76 76" width="76" height="76">
          <circle class="wr-track" cx="38" cy="38" r="31"/>
          <circle class="wr-arc" id="wrArc" cx="38" cy="38" r="31"
            stroke="var(--green)"
            stroke-dasharray="194.8"
            stroke-dashoffset="194.8"/>
        </svg>
        <div class="wr-center">
          <div class="wr-num g" id="wrNum">0%</div>
          <div class="wr-micro">WIN</div>
        </div>
      </div>
      <div class="wr-list">
        <div class="wr-row">
          <span class="wr-row-key">Wins</span>
          <span class="wr-row-val g" id="wr_w">0</span>
        </div>
        <div class="wr-bar-wrap"><div class="wr-bar-fill" id="wr_wbar" style="width:0%;background:var(--green)"></div></div>
        <div class="wr-row">
          <span class="wr-row-key">Losses</span>
          <span class="wr-row-val r" id="wr_l">0</span>
        </div>
        <div class="wr-bar-wrap"><div class="wr-bar-fill" id="wr_lbar" style="width:0%;background:var(--red)"></div></div>
        <div class="wr-row">
          <span class="wr-row-key">Open</span>
          <span class="wr-row-val b" id="wr_o">0</span>
        </div>
      </div>
    </div>
  </div>

  <!-- BTC Ticker -->
  <div class="sb-section">
    <div class="sb-label">BTC Live Price</div>
    <div class="btc-sub">
      <div>
        <div class="btc-price-main" id="btcMain">$‚Äî</div>
        <div class="btc-avg-label">5 Exchange Avg.</div>
      </div>
      <div class="btc-spread-val" id="btcSpread">spread: ‚Äî</div>
    </div>
    <canvas id="btcCanvas" height="40" class="btc-canvas"></canvas>
    <div id="btcExList"></div>
  </div>

  <!-- AutoTrader -->
  <div class="sb-section">
    <div class="sb-label">Auto Trader</div>
    <div class="auto-card">
      <div class="auto-head">
        <div class="auto-head-title">
          <div class="status-dot" id="statusDot"></div>
          <span>Auto Scanner</span>
        </div>
        <span class="status-label off" id="statusLbl">STOPPED</span>
      </div>
      <div class="auto-body">
        <div class="auto-grid">
          <div class="ag-cell"><div class="ag-val" id="as_sc">0</div><div class="ag-key">SCANS</div></div>
          <div class="ag-cell"><div class="ag-val" id="as_bt">0</div><div class="ag-key">AUTO BET</div></div>
          <div class="ag-cell"><div class="ag-val" id="as_rv">0</div><div class="ag-key">RESOLVE</div></div>
          <div class="ag-cell"><div class="ag-val y" id="as_dy">$0</div><div class="ag-key">DAILY</div></div>
        </div>
        <div class="scan-row">
          <span>Next scan</span>
          <span class="scan-time" id="scanLbl">‚Äî</span>
        </div>
        <div class="prog-track"><div class="prog-fill" id="progFill" style="width:0%"></div></div>
        <div class="cfg-row">
          <span class="cfg-lbl">INTERVAL:</span>
          <input class="cfg-inp" type="number" id="cfgInt" value="300" min="30">
          <span class="cfg-lbl">EDGE%:</span>
          <input class="cfg-inp" type="number" id="cfgEdge" value="15" min="1">
        </div>
        <div class="btn-row">
          <button class="btn btn-go" onclick="startAuto()">‚ñ∂ START</button>
          <button class="btn btn-halt" onclick="stopAuto()">‚ñ† STOP</button>
        </div>
        <div class="btn-row" style="margin-top:5px">
          <button class="btn btn-scan" onclick="scanNow()"><span id="scanIcon">‚ü≥</span> SCAN NOW</button>
          <button class="btn btn-reset" onclick="resetSim()">RESET</button>
        </div>
      </div>
    </div>
  </div>

</aside>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN AREA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<main class="main-area">

  <!-- Daily Strip -->
  <div class="daily-strip">
    <div class="ds-item">
      <div class="ds-val b" id="ds_start">$‚Äî</div>
      <div class="ds-key">Start Balance</div>
    </div>
    <div class="ds-item">
      <div class="ds-val" id="ds_pnl">$‚Äî</div>
      <div class="ds-key">Total P&amp;L</div>
    </div>
    <div class="ds-item">
      <div class="ds-val g" id="ds_wins">0</div>
      <div class="ds-key">Winning</div>
    </div>
    <div class="ds-item">
      <div class="ds-val r" id="ds_losses">0</div>
      <div class="ds-key">Losing</div>
    </div>
    <div class="ds-item">
      <div class="ds-val y" id="ds_invest">$‚Äî</div>
      <div class="ds-key">Total Invested</div>
    </div>
  </div>

  <!-- Tab Strip -->
  <div class="tab-strip">
    <button class="tab active" onclick="showTab('chart',this)">üìà PNL CHART</button>
    <button class="tab" onclick="showTab('opps',this)">üéØ OPPORTUNITIES <span class="tab-badge" id="tc_opps">0</span></button>
    <button class="tab" onclick="showTab('history',this)">üìã TRADE HISTORY</button>
    <button class="tab" onclick="showTab('logs',this)">üìü LIVE LOG</button>
  </div>

  <!-- Panels -->
  <div class="panels">

    <!-- ‚îÄ‚îÄ‚îÄ CHART PANEL ‚îÄ‚îÄ‚îÄ -->
    <div class="panel active" id="panel-chart">
      <div class="kpi-strip">
        <div class="kpi"><div class="kpi-val" style="color:var(--teal)" id="kpi_port">$‚Äî</div><div class="kpi-key">Portfolio Value</div></div>
        <div class="kpi"><div class="kpi-val" id="kpi_tpnl">$‚Äî</div><div class="kpi-key">Total PnL</div></div>
        <div class="kpi"><div class="kpi-val g" id="kpi_real">$‚Äî</div><div class="kpi-key">Realized</div></div>
        <div class="kpi"><div class="kpi-val" style="color:var(--teal)" id="kpi_unreal">$‚Äî</div><div class="kpi-key">Unrealized</div></div>
        <div class="kpi"><div class="kpi-val y" id="kpi_open">‚Äî</div><div class="kpi-key">Open Positions</div></div>
        <div class="kpi"><div class="kpi-val" id="kpi_wr">‚Äî%</div><div class="kpi-key">Win Rate</div></div>
      </div>

      <div class="chart-card">
        <div class="chart-card-hdr">
          <div class="chart-card-title">PORTFOLIO PNL ‚Äî TIME SERIES</div>
          <div class="period-row">
            <button class="pbtn active" onclick="setPeriod('1h',this)">1H</button>
            <button class="pbtn" onclick="setPeriod('6h',this)">6H</button>
            <button class="pbtn" onclick="setPeriod('24h',this)">24H</button>
            <button class="pbtn" onclick="setPeriod('all',this)">ALL</button>
            <button class="pbtn" onclick="loadChart()">‚ü≥</button>
          </div>
        </div>
        <div class="chart-wrap"><canvas id="mainChart"></canvas></div>
      </div>

      <div class="sub-grid">
        <div class="sub-chart-card">
          <div class="sub-chart-title">Portfolio Value</div>
          <div class="sub-chart-wrap"><canvas id="portChart"></canvas></div>
        </div>
        <div class="sub-chart-card">
          <div class="sub-chart-title">Realized vs Unrealized PnL</div>
          <div class="sub-chart-wrap"><canvas id="breakChart"></canvas></div>
        </div>
        <div class="sub-chart-card">
          <div class="sub-chart-title">Win Rate Trend</div>
          <div class="sub-chart-wrap"><canvas id="wrChart"></canvas></div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ OPPORTUNITIES PANEL ‚îÄ‚îÄ‚îÄ -->
    <div class="panel" id="panel-opps">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-family:var(--mono);font-size:10px;color:var(--text2);font-weight:600;letter-spacing:.06em">ARBITRAGE OPPORTUNITIES ‚Äî LIVE CLOB DATA</div>
        <button class="btn btn-scan" style="flex:none;padding:7px 16px;font-size:10px" onclick="loadOpps()">
          <span class="spin" id="oppSpinner" style="display:none"></span>‚ü≥ TARA
        </button>
      </div>
      <div class="opp-table-wrap">
        <table class="opp-table">
          <thead><tr><th>Market</th><th>Type</th><th>Real %</th><th>Market %</th><th>Edge</th><th>Side</th><th>Action</th></tr></thead>
          <tbody id="oppBody"><tr><td colspan="7" class="empty">Click Opportunities tab or start Auto Trader</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ HISTORY PANEL ‚îÄ‚îÄ‚îÄ -->
    <div class="panel" id="panel-history">
      <div class="hist-table-wrap">
        <table class="hist-table">
          <thead><tr><th>Time</th><th>Market</th><th>Side</th><th>Amount</th><th>Entry</th><th>Result</th><th>PnL</th></tr></thead>
          <tbody id="histBody"><tr><td colspan="7" class="empty">No trades yet</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ LOG PANEL ‚îÄ‚îÄ‚îÄ -->
    <div class="panel" id="panel-logs">
      <div class="log-wrap">
        <div class="log-hdr">
          <div class="log-hdr-title">LIVE BOT LOG</div>
          <button class="pbtn" onclick="document.getElementById('logFeed').innerHTML=''">Clear</button>
        </div>
        <div class="log-feed" id="logFeed">
          <div class="log-line">System starting...</div>
        </div>
      </div>
    </div>

  </div><!-- /panels -->
</main>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RIGHT RAIL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<aside class="right-rail">

  <div class="rail-section">
    <div class="rail-hdr">
      <div class="rail-hdr-title">OPEN POSITIONS</div>
      <span class="rail-badge open" id="rp_open">0</span>
    </div>
    <div class="pos-list" id="posListEl">
      <div class="empty">No open positions</div>
    </div>
  </div>

  <div class="rail-section" style="flex:1">
    <div class="rail-hdr">
      <div class="rail-hdr-title">CLOSED BETS</div>
      <span class="rail-badge closed" id="rp_closed">0</span>
    </div>
    <div class="closed-list" id="closedListEl">
      <div class="empty">No closed bets yet</div>
    </div>
  </div>

</aside>

</div><!-- /app -->

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let ws=null, tick=0;
let scanIntervalSec=300, nextScanTime=null;
let btcSparkData=[];
let chartPeriod='1h';
let charts={};
let positions=[], closedTrades=[];
let prevPrices={};
let dailyStartBal=null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLOCK + DAILY RESET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
setInterval(()=>{
  const n=new Date();
  document.getElementById('clockEl').textContent=n.toLocaleTimeString('en-US',{hour12:false});
  // Midnight reset
  if(n.getHours()===0&&n.getMinutes()===0&&n.getSeconds()===0){
    const cur=parseFloat(document.getElementById('sb_bal').textContent.replace(/[$,]/g,''))||0;
    dailyStartBal=cur;
    try{localStorage.setItem('polyarb_daily',JSON.stringify({bal:cur,date:n.toDateString()}));}catch(e){}
    log('üïõ Daily start balance updated: $'+cur.toFixed(2),'s');
  }
},1000);

function initDailyBalance(){
  try{
    const s=JSON.parse(localStorage.getItem('polyarb_daily')||'null');
    if(s&&s.date===new Date().toDateString()){
      dailyStartBal=s.bal;
      document.getElementById('ds_start').textContent='$'+s.bal.toFixed(2);
    }
  }catch(e){}
}
initDailyBalance();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WEBSOCKET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function connectWS(){
  const proto=location.protocol==='https:'?'wss':'ws';
  ws=new WebSocket(`${proto}://${location.host}/ws`);
  ws.onopen=()=>{ setWS('live','LIVE'); log('‚úì WebSocket connected','s'); loadInit(); };
  ws.onmessage=e=>{ try{handle(JSON.parse(e.data));}catch(_){} };
  let delay=2000;
  ws.onclose=()=>{ setWS('err','DISCONNECTED'); log('‚ö† Connection lost...','w'); startPoll(); setTimeout(()=>{delay=Math.min(delay*1.5,15000);connectWS();},delay); };
  ws.onerror=()=>{ setWS('err','ERROR'); startPoll(); };
}
let pollTmr=null;
function startPoll(){
  if(pollTmr)return;
  pollTmr=setInterval(async()=>{ try{ const d=await(await fetch('/api/live-prices')).json(); if(d.btc)updateBTC(d.btc); }catch(e){} },4000);
}
function setWS(state,txt){
  document.getElementById('wsPill').className='ws-pill '+state;
  document.getElementById('wsLbl').textContent=txt;
}

function handle(msg){
  tick++;
  if(msg.type==='live_update'){
    const d=msg.data;
    if(d.btc)updateBTC(d.btc);
    if(d.portfolio_full)updatePortfolio(d.portfolio_full);
    if(d.positions!==undefined){ positions=d.positions; renderPositions(positions,d.position_prices||{}); }
    if(d.auto_status)updateAutoStatus(d.auto_status);
    if(d.auto_status?.last_logs)d.auto_status.last_logs.forEach(l=>log(l.msg,ll(l.level)));
    if(d.auto_status?.last_opportunities?.length)renderOpps(d.auto_status.last_opportunities);
  }else if(msg.type==='scan_start'){
    document.getElementById('scanIcon').innerHTML='<span class="spin"></span>';
    log('‚ü≥ Scan started...','w');
  }else if(msg.type==='scan_result'){
    document.getElementById('scanIcon').textContent='‚ü≥';
    const all=[...(msg.data.weather_opportunities||[]),...(msg.data.btc_opportunities||[]),...(msg.data.metals_opportunities||[])];
    if(all.length)renderOpps(all);
    log(`‚úì Scan: ${msg.data.total_opportunities||0} opportunities found`,'s');
  }
}
function ll(l){return l==='success'?'s':l==='warning'?'w':l==='error'?'e':'';}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BTC TICKER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let btcMini=null;
function updateBTC(btc){
  if(!btc||!btc.average)return;
  const avg=btc.average;
  document.getElementById('btcMain').textContent='$'+Math.round(avg).toLocaleString('en-US');
  document.getElementById('tb_btc').textContent='$'+Math.round(avg).toLocaleString('en-US');
  document.getElementById('btcSpread').textContent='spread: $'+Math.round(btc.spread||0).toLocaleString();

  btcSparkData.push(avg);
  if(btcSparkData.length>80)btcSparkData.shift();
  drawBtcSpark();

  if(btc.prices&&Object.keys(btc.prices).length){
    document.getElementById('btcExList').innerHTML=Object.entries(btc.prices).map(([ex,p])=>{
      const d=avg>0?((p-avg)/avg*100):0;
      const dc=d>0?'var(--green)':d<0?'var(--red)':'var(--text3)';
      return `<div class="btc-ex-row">
        <span class="btc-ex-name">${ex.toUpperCase()}</span>
        <span class="btc-ex-price">$${Math.round(p).toLocaleString()}</span>
        <span class="btc-ex-delta" style="color:${dc}">${d>=0?'+':''}${d.toFixed(2)}%</span>
      </div>`;
    }).join('');
  }
}
function drawBtcSpark(){
  const c=document.getElementById('btcCanvas');
  if(!c||btcSparkData.length<2)return;
  c.width=c.offsetWidth||230; c.height=40;
  const ctx=c.getContext('2d'),w=c.width,h=40;
  const mn=Math.min(...btcSparkData),mx=Math.max(...btcSparkData),rng=mx-mn||1;
  ctx.clearRect(0,0,w,h);
  const g=ctx.createLinearGradient(0,0,0,h);
  g.addColorStop(0,'rgba(255,204,68,.35)');g.addColorStop(1,'rgba(255,204,68,0)');
  ctx.beginPath();
  btcSparkData.forEach((v,i)=>{
    const x=(i/(btcSparkData.length-1))*w;
    const y=h-((v-mn)/rng)*(h-6)-3;
    i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
  });
  ctx.strokeStyle='var(--gold)';ctx.lineWidth=1.8;ctx.stroke();
  ctx.lineTo(w,h);ctx.lineTo(0,h);ctx.closePath();
  ctx.fillStyle=g;ctx.fill();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PORTFOLIO ‚Äî diffing, no page jitter
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updatePortfolio(p){
  if(!p)return;
  const bal=p.balance||0, pnl=p.total_pnl||0, wr=p.win_rate||0;
  const real=p.realized_pnl||0, unreal=p.unrealized_pnl||0, inv=p.total_invested||0;
  const wins=p.win_count||0, losses=Math.max(0,(p.closed_trades||0)-wins);
  const pct=Math.min(100,Math.max(0,wr));
  const portVal=bal+inv;

  // ‚îÄ‚îÄ Sidebar balance ‚îÄ‚îÄ
  setTxt('sb_bal','$'+bal.toFixed(2));
  const rEl=document.getElementById('sb_real');
  if(rEl){
    const rv=(real>=0?'+$':'‚àí$')+Math.abs(real).toFixed(2);
    flashNum(rEl,rv,real>=0?'g':'r');
  }
  const uEl=document.getElementById('sb_unreal');
  if(uEl) flashNum(uEl,(unreal>=0?'+$':'‚àí$')+Math.abs(unreal).toFixed(2));
  setTxt('sb_inv','$'+inv.toFixed(2));

  // ‚îÄ‚îÄ Win Rate donut ‚îÄ‚îÄ
  const arc=document.getElementById('wrArc');
  if(arc){
    const circ=2*Math.PI*31;
    const offset=(circ-(pct/100)*circ);
    arc.style.strokeDashoffset=offset;
    arc.style.stroke=pct>=50?'var(--green)':'var(--red)';
  }
  const wrNumEl=document.getElementById('wrNum');
  if(wrNumEl){ wrNumEl.textContent=pct.toFixed(1)+'%'; wrNumEl.className='wr-num '+(pct>=50?'g':'r'); }
  const total=Math.max(1,p.closed_trades||1);
  setTxt('wr_w',wins); setTxt('wr_l',losses); setTxt('wr_o',p.open_positions||0);
  const wbar=document.getElementById('wr_wbar'); if(wbar)wbar.style.width=Math.min(100,(wins/total)*100)+'%';
  const lbar=document.getElementById('wr_lbar'); if(lbar)lbar.style.width=Math.min(100,(losses/total)*100)+'%';

  // ‚îÄ‚îÄ Topbar ‚îÄ‚îÄ
  const tbBal=document.getElementById('tb_bal'); if(tbBal)flashNum(tbBal,'$'+bal.toFixed(2));
  const tbPnl=document.getElementById('tb_pnl');
  if(tbPnl){ flashNum(tbPnl,(pnl>=0?'+':'‚àí')+'$'+Math.abs(pnl).toFixed(2),pnl>=0?'g':'r'); tbPnl.className='tb-val '+(pnl>=0?'g':'r'); }
  setTxt('tb_open',p.open_positions||0);
  const tbWr=document.getElementById('tb_wr');
  if(tbWr){ tbWr.textContent=pct.toFixed(1)+'%'; tbWr.className='tb-val '+(pct>=50?'g':'r'); }

  // ‚îÄ‚îÄ Daily strip ‚îÄ‚îÄ
  if(!dailyStartBal){
    dailyStartBal=bal;
    try{localStorage.setItem('polyarb_daily',JSON.stringify({bal,date:new Date().toDateString()}));}catch(e){}
  }
  setTxt('ds_start','$'+dailyStartBal.toFixed(2));
  const dpnl=bal-dailyStartBal;
  const dpEl=document.getElementById('ds_pnl');
  if(dpEl){ flashNum(dpEl,(dpnl>=0?'+':'‚àí')+'$'+Math.abs(dpnl).toFixed(2),dpnl>=0?'g':'r'); dpEl.className='ds-val '+(dpnl>=0?'g':'r'); }
  setTxt('ds_wins',wins); setTxt('ds_losses',losses); setTxt('ds_invest','$'+inv.toFixed(2));

  // ‚îÄ‚îÄ KPI strip ‚îÄ‚îÄ
  const kPort=document.getElementById('kpi_port'); if(kPort)flashNum(kPort,'$'+portVal.toFixed(2));
  const kPnl=document.getElementById('kpi_tpnl');
  if(kPnl){ flashNum(kPnl,(pnl>=0?'+':'‚àí')+'$'+Math.abs(pnl).toFixed(2),pnl>=0?'g':'r'); kPnl.className='kpi-val '+(pnl>=0?'g':'r'); }
  const kReal=document.getElementById('kpi_real'); if(kReal)flashNum(kReal,(real>=0?'+':'‚àí')+'$'+Math.abs(real).toFixed(2));
  const kUnreal=document.getElementById('kpi_unreal'); if(kUnreal)flashNum(kUnreal,(unreal>=0?'+':'‚àí')+'$'+Math.abs(unreal).toFixed(2));
  setTxt('kpi_open',p.open_positions||0);
  const kWr=document.getElementById('kpi_wr');
  if(kWr){ kWr.textContent=pct.toFixed(1)+'%'; kWr.className='kpi-val '+(pct>=50?'g':'r'); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// POSITIONS ‚Äî RIGHT RAIL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ‚îÄ SMART DOM DIFFING: only update changed elements ‚îÄ‚îÄ‚îÄ
function setTxt(id, val){
  const el=document.getElementById(id);
  if(el&&el.textContent!==String(val)) el.textContent=val;
}
function setStyle(el, prop, val){
  if(el&&el.style[prop]!==val) el.style[prop]=val;
}

// Light flash effect on number change (glow, no page jitter)
function flashNum(el, newTxt, colorClass){
  if(!el||el.textContent===newTxt) return;
  el.textContent=newTxt;
  if(colorClass){
    el.className=el.className.replace(/\b[grby]\b/g,'').trim()+' '+colorClass;
  }
  el.style.transition='opacity .15s';
  el.style.opacity='0.5';
  requestAnimationFrame(()=>{
    requestAnimationFrame(()=>{
      el.style.opacity='1';
    });
  });
}

// Card HTML template (used only for initial creation)
function buildPosCard(pos, ld){
  const mid=pos.market_id||'';
  const lp=ld.price||0;
  const upnl=ld.unrealized_pnl;
  const upnlColor=upnl>0?'var(--green)':upnl<0?'var(--red)':'var(--text3)';
  const side=pos.side||'YES';
  const edge=(pos.edge_at_entry||0)*100;
  const edgeCol=edge>0?'var(--green)':'var(--red)';
  let progress=lp>0?(side==='YES'?lp*100:(1-lp)*100):50;
  const progCol=progress>65?'var(--green)':progress>40?'var(--gold)':'var(--red)';
  let daysLeft='';
  if(pos.end_date){
    const diff=Math.ceil((new Date(pos.end_date)-Date.now())/86400000);
    daysLeft=diff>0?`${diff}d`:'EXPIRED';
  }
  const liquidity=ld.liquid?'<span style="color:var(--green);font-size:9px;margin-left:4px">‚óèLIQ</span>':'';
  return `<div class="pos-card" id="pc_${pos.id}" data-mid="${mid}">
    <div class="pos-top">
      <div class="pos-mkt" title="${pos.market}">${pos.market}</div>
      <div class="pos-tags">
        <span class="tag tg-${side.toLowerCase()}">${side}</span>
        <span class="tag tg-${pos.type||'btc'}">${pos.type||'btc'}</span>
      </div>
    </div>
    <div class="pos-stats">
      <div class="ps"><div class="ps-val y">$${(pos.amount||0).toFixed(2)}</div><div class="ps-key">INVESTED</div></div>
      <div class="ps"><div class="ps-val">${(pos.entry_price||0).toFixed(3)}</div><div class="ps-key">ENTRY</div></div>
      <div class="ps"><div class="ps-val" style="color:${edgeCol}" id="edge_${pos.id}">${edge>=0?'+':''}${edge.toFixed(1)}%</div><div class="ps-key">EDGE</div></div>
      <div class="ps"><div class="ps-val" id="days_${pos.id}" style="font-size:${daysLeft.length>4?'9px':'11px'};color:${daysLeft==='EXPIRED'?'var(--red)':'var(--text3)'}">${daysLeft||'‚Äî'}</div><div class="ps-key">TIME</div></div>
    </div>
    <div class="pos-live">
      <span class="pos-live-lbl">Live Price${liquidity}</span>
      <span class="pos-live-price" id="lp_${pos.id}">${lp>0?lp.toFixed(4):'‚Äî'}</span>
      <span class="pos-upnl" id="upnl_${pos.id}" style="color:${upnlColor}">${upnl!==undefined?(upnl>=0?'+':'')+'$'+Math.abs(upnl).toFixed(3):'‚Äî'}</span>
    </div>
    <div class="pos-prog"><div class="pos-prog-fill" id="prog_${pos.id}" style="width:${progress.toFixed(1)}%;background:${progCol}"></div></div>
    <div class="pos-foot">
      <button class="pf-btn yes" onclick="resolve('${pos.id}','YES')">‚úì YES RESOLVE</button>
      <button class="pf-btn no" onclick="resolve('${pos.id}','NO')">‚úó NO RESOLVE</button>
    </div>
    <div class="pos-hover-detail">
      <div class="phd-inner">
        <div class="phd-item"><div class="phd-val">${pos.id}</div><div>ID</div></div>
        <div class="phd-item"><div class="phd-val">${new Date(pos.ts||'').toLocaleTimeString('en-US')}</div><div>Opened</div></div>
        <div class="phd-item"><div class="phd-val">${pos.end_date?new Date(pos.end_date).toLocaleDateString('en-US'):'‚Äî'}</div><div>End Date</div></div>
        <div class="phd-item"><div class="phd-val" id="spr_${pos.id}">${ld.spread!==undefined?ld.spread.toFixed(4):'‚Äî'}</div><div>Spread</div></div>
      </div>
    </div>
  </div>`;
}

// Update only live-changing fields (with flash animation)
function patchPosCard(pos, ld){
  const mid=pos.market_id||'';
  const lp=ld.price||0;
  const upnl=ld.unrealized_pnl;

  // Live price ‚Äî tick animation
  const lpEl=document.getElementById('lp_'+pos.id);
  if(lpEl){
    const prev=prevPrices[mid]||lp;
    const newTxt=lp>0?lp.toFixed(4):'‚Äî';
    if(lpEl.textContent!==newTxt){
      lpEl.textContent=newTxt;
      lpEl.className='pos-live-price '+(lp>prev?'tick-up':lp<prev?'tick-down':'');
      setTimeout(()=>{ if(lpEl)lpEl.className='pos-live-price'; }, 600);
    }
    prevPrices[mid]=lp;
  }

  // Unrealized PnL
  const upnlEl=document.getElementById('upnl_'+pos.id);
  if(upnlEl&&upnl!==undefined){
    const newUpnlTxt=(upnl>=0?'+':'')+'$'+Math.abs(upnl).toFixed(3);
    if(upnlEl.textContent!==newUpnlTxt){
      upnlEl.textContent=newUpnlTxt;
      upnlEl.style.color=upnl>0?'var(--green)':upnl<0?'var(--red)':'var(--text3)';
    }
  }

  // Progress bar
  const progEl=document.getElementById('prog_'+pos.id);
  if(progEl&&lp>0){
    const side=pos.side||'YES';
    const progress=side==='YES'?lp*100:(1-lp)*100;
    const progCol=progress>65?'var(--green)':progress>40?'var(--gold)':'var(--red)';
    const newW=progress.toFixed(1)+'%';
    if(progEl.style.width!==newW){ progEl.style.width=newW; progEl.style.background=progCol; }
  }

  // Spread
  const sprEl=document.getElementById('spr_'+pos.id);
  if(sprEl&&ld.spread!==undefined){
    const newSpr=ld.spread.toFixed(4);
    if(sprEl.textContent!==newSpr)sprEl.textContent=newSpr;
  }
}

function renderPositions(positions, livePrices){
  const list=document.getElementById('posListEl');
  document.getElementById('rp_open').textContent=positions.length;
  document.getElementById('tb_open').textContent=positions.length;

  if(!positions.length){
    if(!list.querySelector('.empty'))list.innerHTML='<div class="empty">No open positions</div>';
    return;
  }

  // Collect existing card IDs
  const existingIds=new Set([...list.querySelectorAll('.pos-card')].map(c=>c.id.replace('pc_','')));
  const newIds=new Set(positions.map(p=>p.id));

  // Remove closed positions (with slide-out animation)
  for(const id of existingIds){
    if(!newIds.has(id)){
      const card=document.getElementById('pc_'+id);
      if(card&&!card.classList.contains('slide-out')){
        card.classList.add('slide-out');
        setTimeout(()=>card.remove(),420);
      }
    }
  }

  // Add new positions or update existing ones
  positions.forEach((pos,idx)=>{
    const mid=pos.market_id||'';
    const ld=livePrices[mid]||{};
    const existingCard=document.getElementById('pc_'+pos.id);

    if(!existingCard){
      // New card ‚Äî create and insert
      const tmp=document.createElement('div');
      tmp.innerHTML=buildPosCard(pos,ld);
      const card=tmp.firstElementChild;
      card.style.opacity='0';
      card.style.transform='translateY(-8px)';
      list.insertBefore(card, list.children[idx]||null);
      // Fade-in
      requestAnimationFrame(()=>{
        card.style.transition='opacity .35s,transform .35s';
        card.style.opacity='1'; card.style.transform='translateY(0)';
      });
    } else {
      // Existing card ‚Äî only update changed values
      patchPosCard(pos, ld);
    }
  });
}

// ‚îÄ‚îÄ‚îÄ CLOSED ‚Äî only add new, don't touch existing ‚îÄ‚îÄ‚îÄ
let _knownClosedIds=new Set();
function renderClosed(trades){
  const list=document.getElementById('closedListEl');
  document.getElementById('rp_closed').textContent=trades.length;
  if(!trades.length){
    if(!list.querySelector('.empty'))list.innerHTML='<div class="empty">No closed bets yet</div>';
    return;
  }

  // Batch render on initial load
  if(_knownClosedIds.size===0&&trades.length>0){
    list.innerHTML=[...trades].reverse().slice(0,30).map(t=>{
      const pnl=t.pnl||0;
      const ts=new Date(t.resolved_at||t.ts||'').toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
      return `<div class="closed-card ${pnl>=0?'w':'l'}" data-id="${t.id}">
        <div class="closed-main">
          <div class="closed-mkt" title="${t.market}">${t.market}</div>
          <div class="closed-meta">
            <span class="tag tg-${(t.side||'YES').toLowerCase()}" style="font-size:8px">${t.side||'YES'}</span>
            <span style="font-size:9px;color:var(--text3)">${ts} ¬∑ $${(t.amount||0).toFixed(2)}</span>
          </div>
        </div>
        <div class="closed-pnl" style="color:${pnl>=0?'var(--green)':'var(--red)'}">${pnl>=0?'+':''}$${Math.abs(pnl).toFixed(2)}</div>
      </div>`;
    }).join('');
    trades.forEach(t=>_knownClosedIds.add(t.id));
    return;
  }

  // Only prepend newly closed trades
  const newTrades=trades.filter(t=>!_knownClosedIds.has(t.id));
  newTrades.forEach(t=>{
    _knownClosedIds.add(t.id);
    const pnl=t.pnl||0;
    const ts=new Date(t.resolved_at||t.ts||'').toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
    const el=document.createElement('div');
    el.className=`closed-card ${pnl>=0?'w':'l'}`;
    el.dataset.id=t.id;
    el.style.opacity='0'; el.style.transform='translateX(-12px)';
    el.innerHTML=`<div class="closed-main">
      <div class="closed-mkt" title="${t.market}">${t.market}</div>
      <div class="closed-meta">
        <span class="tag tg-${(t.side||'YES').toLowerCase()}" style="font-size:8px">${t.side||'YES'}</span>
        <span style="font-size:9px;color:var(--text3)">${ts} ¬∑ $${(t.amount||0).toFixed(2)}</span>
      </div>
    </div>
    <div class="closed-pnl" style="color:${pnl>=0?'var(--green)':'var(--red)'}">${pnl>=0?'+':''}$${Math.abs(pnl).toFixed(2)}</div>`;
    // Insert at top of list (newest first)
    list.insertBefore(el, list.firstChild);
    requestAnimationFrame(()=>{
      el.style.transition='opacity .4s,transform .4s';
      el.style.opacity='1'; el.style.transform='translateX(0)';
    });
    // Keep max 30 cards
    while(list.children.length>30)list.removeChild(list.lastChild);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OPPORTUNITIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderOpps(opps){
  document.getElementById('tc_opps').textContent=opps.length;
  const tbody=document.getElementById('oppBody');
  if(!opps.length){ tbody.innerHTML='<tr><td colspan="7" class="empty">No opportunities found</td></tr>'; return; }
  tbody.innerHTML=opps.slice(0,40).map(o=>{
    const edge=o.edge||0;
    const ec=edge>0.25?'eh':edge>0.15?'em':edge>0?'el':'en';
    const rp=((o.noaa_prob||o.real_prob||0)*100).toFixed(1);
    return `<tr>
      <td class="opp-mkt" title="${o.market}">${o.market}</td>
      <td><span class="tag tg-${o.type}">${o.type}</span></td>
      <td>${rp}%</td>
      <td>${((o.market_price||0)*100).toFixed(1)}%</td>
      <td class="${ec}">${edge>=0?'+':''}${(edge*100).toFixed(1)}%</td>
      <td><span class="tag tg-${(o.side||'YES').toLowerCase()}">${o.side||'YES'}</span></td>
      <td><button class="bet-btn" onclick='quickBet(${JSON.stringify(JSON.stringify(o))})'>BET</button></td>
    </tr>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HISTORY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderHistory(trades){
  const tbody=document.getElementById('histBody');
  if(!trades.length){ tbody.innerHTML='<tr><td colspan="7" class="empty">No trades yet</td></tr>'; return; }
  tbody.innerHTML=[...trades].reverse().map(t=>{
    const pnl=t.pnl||0, st=t.status||'open';
    return `<tr>
      <td style="font-family:var(--mono);font-size:10px;color:var(--text3);white-space:nowrap">${new Date(t.ts).toLocaleString('en-US')}</td>
      <td class="opp-mkt" title="${t.market}">${t.market}</td>
      <td><span class="tag tg-${(t.side||'YES').toLowerCase()}">${t.side}</span></td>
      <td style="font-family:var(--mono)">$${(t.amount||0).toFixed(2)}</td>
      <td style="font-family:var(--mono)">${(t.entry_price||0).toFixed(3)}</td>
      <td><span class="tag tg-${st}">${st.toUpperCase()}</span></td>
      <td style="font-family:var(--mono);font-weight:800;color:${pnl>=0?'var(--green)':'var(--red)'}">${pnl?(pnl>0?'+':'')+'$'+Math.abs(pnl).toFixed(2):'‚Äî'}</td>
    </tr>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTO TRADER STATUS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateAutoStatus(s){
  const running=s.running;
  const dot=document.getElementById('statusDot');
  const lbl=document.getElementById('statusLbl');
  dot.className='status-dot '+(running?'on':'');
  lbl.textContent=running?'RUNNING':'STOPPED';
  lbl.className='status-label '+(running?'on':'off');
  document.getElementById('as_sc').textContent=s.scan_count||0;
  document.getElementById('as_bt').textContent=s.auto_bets||0;
  document.getElementById('as_rv').textContent=s.auto_resolves||0;
  document.getElementById('as_dy').textContent='$'+(s.daily_spent||0).toFixed(2);
  if(s.next_scan&&running){ nextScanTime=new Date(s.next_scan); scanIntervalSec=s.scan_interval||scanIntervalSec; }
}
setInterval(()=>{
  if(!nextScanTime)return;
  const now=Date.now(),next=nextScanTime.getTime();
  const interval=scanIntervalSec*1000;
  const elapsed=interval-(next-now);
  const pct=Math.max(0,Math.min(100,elapsed/interval*100));
  document.getElementById('progFill').style.width=pct+'%';
  const secs=Math.max(0,Math.round((next-now)/1000));
  document.getElementById('scanLbl').textContent=secs+'s';
},1000);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHARTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CO={
  responsive:true,maintainAspectRatio:false,animation:{duration:400},
  plugins:{
    legend:{labels:{color:'#7d8fa3',font:{family:"'JetBrains Mono'",size:10},boxWidth:10,padding:10}},
    tooltip:{backgroundColor:'#1c2a3a',borderColor:'#1e2d40',borderWidth:1,
      titleColor:'#eef2f8',bodyColor:'#7d8fa3',
      titleFont:{family:"'JetBrains Mono'",size:10},bodyFont:{family:"'JetBrains Mono'",size:10},
      padding:10,cornerRadius:6,}
  },
  scales:{
    x:{ticks:{color:'#3d5166',font:{family:"'JetBrains Mono'",size:9},maxTicksLimit:8},grid:{color:'#1e2d40'}},
    y:{ticks:{color:'#3d5166',font:{family:"'JetBrains Mono'",size:9}},grid:{color:'#1e2d40'}}
  }
};
function dc(id){
  if(charts[id]){
    try{charts[id].destroy();}catch(e){}
    delete charts[id];
  }
}

async function loadChart(){
  try{
    // Wait for canvas wrapper layout to complete
    await new Promise(r=>requestAnimationFrame(()=>requestAnimationFrame(r)));
    const d=await(await fetch(`/api/pnl-history?limit=300&period=${chartPeriod}`)).json();
    renderCharts(d);
  }catch(e){log('Chart error: '+e.message,'e');}
}

// Chart shared settings
const C_GREEN='#39e8a8', C_RED='#ff4d6a', C_AMBER='#f5c842';
const C_TEAL='#2dd4bf', C_VIOLET='#c084fc', C_ROSE='#fb7185';
const C_GRID='#1e1e30', C_TICK='#454360';
const FONT={family:"'JetBrains Mono'",size:10};

// Draw info message on empty canvas
function drawEmptyChart(canvasId, msg='Chart will populate while bot is running'){
  const canvas=document.getElementById(canvasId);
  if(!canvas)return;
  // Get dimensions from wrapper div
  const wrap=canvas.parentElement;
  const w=wrap?wrap.clientWidth:canvas.offsetWidth||400;
  const h=wrap?wrap.clientHeight:canvas.offsetHeight||200;
  canvas.width=w; canvas.height=h;
  const ctx=canvas.getContext('2d');
  ctx.clearRect(0,0,w,h);

  // Grid
  ctx.strokeStyle='rgba(37,37,53,.8)'; ctx.lineWidth=1;
  for(let i=1;i<6;i++){
    const y=h*i/6;
    ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(w,y);ctx.stroke();
  }
  for(let i=1;i<9;i++){
    const x=w*i/9;
    ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,h);ctx.stroke();
  }

  // Axis labels
  ctx.font=`400 9px 'JetBrains Mono',monospace`;
  ctx.fillStyle='#303048'; ctx.textAlign='right'; ctx.textBaseline='middle';
  ['0.00','0.20','0.40','0.60','0.80'].forEach((v,i)=>{
    ctx.fillText(v, 36, h-(h*i/5)+2);
  });

  // Center icon
  ctx.font='28px serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.globalAlpha=0.15; ctx.fillStyle='#c084fc';
  ctx.fillText('üìà', w/2, h/2-18); ctx.globalAlpha=1;

  // Message
  ctx.font=`500 12px 'Space Grotesk',sans-serif`;
  ctx.fillStyle='#454360'; ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillText(msg, w/2, h/2+8);
  ctx.font=`400 10px 'JetBrains Mono',monospace`;
  ctx.fillStyle='#252535';
  ctx.fillText('Snapshots recorded every 30 seconds', w/2, h/2+26);
}

function renderCharts(d){
  const hist=d.history||[], init=d.initial_balance||10000;
  if(d.current?.balance)updatePortfolio({
    balance:d.current.balance, total_pnl:d.current.total_pnl,
    realized_pnl:d.current.realized_pnl, unrealized_pnl:d.current.unrealized_pnl,
    open_positions:d.current.open_positions, total_invested:d.current.total_invested||0,
    win_rate:d.current.win_rate, closed_trades:d.current.closed_trades,
    win_count:Math.round((d.current.closed_trades||0)*(d.current.win_rate||0)/100)
  });

  // If no data, draw placeholder and exit
  if(!hist.length){
    drawEmptyChart('mainChart','No PnL data yet ‚Äî is the bot running?');
    drawEmptyChart('portChart','Portfolio Value');
    drawEmptyChart('breakChart','Realized vs Unrealized');
    drawEmptyChart('wrChart','Win Rate Trendi');
    return;
  }

  const labels=hist.map(h=>new Date(h.ts).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'}));
  const totPnl=hist.map(h=>+(h.total_pnl||0).toFixed(4));
  const portVal=hist.map(h=>+(h.portfolio_value||init).toFixed(4));
  const lastPnl=totPnl[totPnl.length-1]||0;
  const pnlColor=lastPnl>=0?C_GREEN:C_RED;
  const pnlGlow=lastPnl>=0?'rgba(57,232,168,':' rgba(255,77,106,';

  // ‚îÄ‚îÄ Main Chart: PnL + Portfolio ‚îÄ‚îÄ
  dc('main');
  charts['main']=new Chart(document.getElementById('mainChart').getContext('2d'),{
    type:'line',
    data:{labels,datasets:[{
      label:'Total PnL ($)',
      data:totPnl,
      borderColor:pnlColor,
      backgroundColor:ctx=>{
        const g=ctx.chart.ctx.createLinearGradient(0,0,0,ctx.chart.height);
        g.addColorStop(0,pnlGlow+'.22)');
        g.addColorStop(0.6,pnlGlow+'.06)');
        g.addColorStop(1,pnlGlow+'0)');
        return g;
      },
      borderWidth:2.5,fill:true,tension:.4,
      pointRadius:hist.length>40?0:4,
      pointBackgroundColor:pnlColor,
      pointHoverRadius:6,
      pointHoverBackgroundColor:'#fff',
      yAxisID:'y',
    },{
      label:'Portfolio ($)',
      data:portVal,
      borderColor:C_TEAL,
      backgroundColor:'transparent',
      borderWidth:1.5,
      borderDash:[6,4],
      tension:.4,
      pointRadius:0,
      pointHoverRadius:4,
      pointHoverBackgroundColor:C_TEAL,
      yAxisID:'y2',
    }]},
    options:{
      responsive:true,maintainAspectRatio:false,
      resizeDelay:100,
      interaction:{mode:'index',intersect:false},
      animation:{duration:600,easing:'easeInOutQuart'},
      plugins:{
        legend:{labels:{color:'#8b889e',font:FONT,boxWidth:10,padding:12,usePointStyle:true}},
        tooltip:{
          backgroundColor:'rgba(20,20,32,.95)',
          borderColor:'#303048',borderWidth:1,
          titleColor:'#f2f0ff',bodyColor:'#8b889e',
          titleFont:{...FONT,weight:'bold'},bodyFont:FONT,
          padding:12,cornerRadius:8,
          callbacks:{
            label:ctx=>`  ${ctx.dataset.label}: ${ctx.parsed.y>=0?'+':''}$${ctx.parsed.y.toFixed(3)}`
          }
        }
      },
      scales:{
        x:{ticks:{color:C_TICK,font:FONT,maxTicksLimit:10},grid:{color:C_GRID,drawBorder:false}},
        y:{
          position:'left',
          ticks:{color:C_TICK,font:FONT,callback:v=>(v>=0?'+':'')+v.toFixed(2)},
          grid:{color:C_GRID,drawBorder:false},
          title:{display:true,text:'PnL ($)',color:C_TICK,font:{size:9}},
        },
        y2:{
          position:'right',
          ticks:{color:C_TICK,font:FONT,callback:v=>'$'+v.toFixed(0)},
          grid:{drawOnChartArea:false},
          title:{display:true,text:'Portfolio ($)',color:C_TICK,font:{size:9}},
        }
      }
    }
  });

  const SUB_OPT={
    responsive:true,maintainAspectRatio:false,
    resizeDelay:100,
    interaction:{mode:'index',intersect:false},
    animation:{duration:500},
    plugins:{
      legend:{labels:{color:'#8b889e',font:{...FONT,size:9},boxWidth:8,padding:8,usePointStyle:true}},
      tooltip:{
        backgroundColor:'rgba(20,20,32,.95)',borderColor:'#303048',borderWidth:1,
        titleColor:'#f2f0ff',bodyColor:'#8b889e',
        titleFont:FONT,bodyFont:{...FONT,size:9},padding:8,cornerRadius:6,
      }
    },
    scales:{
      x:{ticks:{color:C_TICK,font:{...FONT,size:9},maxTicksLimit:6},grid:{color:C_GRID,drawBorder:false}},
      y:{ticks:{color:C_TICK,font:{...FONT,size:9}},grid:{color:C_GRID,drawBorder:false}}
    }
  };

  // ‚îÄ‚îÄ Portfolio Value ‚îÄ‚îÄ
  dc('port');
  charts['port']=new Chart(document.getElementById('portChart').getContext('2d'),{
    type:'line',
    data:{labels,datasets:[{
      label:'Portfolio ($)',
      data:portVal,
      borderColor:C_TEAL,
      backgroundColor:ctx=>{
        const g=ctx.chart.ctx.createLinearGradient(0,0,0,ctx.chart.height);
        g.addColorStop(0,'rgba(45,212,191,.2)');g.addColorStop(1,'rgba(45,212,191,0)');
        return g;
      },
      borderWidth:2,fill:true,tension:.4,pointRadius:0,pointHoverRadius:4,
    },{
      label:'Initial $'+init.toFixed(0),
      data:hist.map(()=>init),
      borderColor:'#303048',borderDash:[6,4],borderWidth:1.5,
      pointRadius:0,backgroundColor:'transparent',
    }]},
    options:SUB_OPT
  });

  // ‚îÄ‚îÄ Realized vs Unrealized ‚Äî gradient bar ‚îÄ‚îÄ
  dc('break');
  charts['break']=new Chart(document.getElementById('breakChart').getContext('2d'),{
    type:'bar',
    data:{labels,datasets:[{
      label:'Realized PnL',
      data:hist.map(h=>+(h.realized_pnl||0).toFixed(4)),
      backgroundColor:hist.map(h=>(h.realized_pnl||0)>=0?'rgba(57,232,168,.65)':'rgba(255,77,106,.65)'),
      borderColor:hist.map(h=>(h.realized_pnl||0)>=0?C_GREEN:C_RED),
      borderWidth:1,borderRadius:3,
    },{
      label:'Unrealized PnL',
      data:hist.map(h=>+(h.unrealized_pnl||0).toFixed(4)),
      backgroundColor:hist.map(h=>(h.unrealized_pnl||0)>=0?'rgba(192,132,252,.55)':'rgba(251,113,133,.55)'),
      borderColor:hist.map(h=>(h.unrealized_pnl||0)>=0?C_VIOLET:C_ROSE),
      borderWidth:1,borderRadius:3,
    }]},
    options:{...SUB_OPT,
      scales:{
        x:{...SUB_OPT.scales.x,stacked:true},
        y:{...SUB_OPT.scales.y,stacked:true,
          ticks:{...SUB_OPT.scales.y.ticks,callback:v=>(v>=0?'+':'')+v.toFixed(2)}
        }
      }
    }
  });

  // ‚îÄ‚îÄ Win Rate ‚Äî area gradient ‚îÄ‚îÄ
  dc('wr');
  charts['wr']=new Chart(document.getElementById('wrChart').getContext('2d'),{
    type:'line',
    data:{labels,datasets:[{
      label:'Win Rate %',
      data:hist.map(h=>+(h.win_rate||0).toFixed(1)),
      borderColor:C_AMBER,
      backgroundColor:ctx=>{
        const g=ctx.chart.ctx.createLinearGradient(0,0,0,ctx.chart.height);
        g.addColorStop(0,'rgba(245,200,66,.25)');g.addColorStop(1,'rgba(245,200,66,0)');
        return g;
      },
      borderWidth:2,fill:true,tension:.4,
      pointRadius:0,pointHoverRadius:4,pointHoverBackgroundColor:C_AMBER,
    },{
      label:'50% Threshold',
      data:hist.map(()=>50),
      borderColor:'#303048',borderDash:[5,4],borderWidth:1.5,
      pointRadius:0,backgroundColor:'transparent',
    }]},
    options:{...SUB_OPT,
      scales:{
        x:SUB_OPT.scales.x,
        y:{...SUB_OPT.scales.y,min:0,max:100,
          ticks:{...SUB_OPT.scales.y.ticks,callback:v=>v+'%'}
        }
      }
    }
  });
}

function setPeriod(p,btn){
  chartPeriod=p;
  document.querySelectorAll('.pbtn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  loadChart();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// API ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _initDone=false;

async function loadInit(){
  try{
    const [pr,ar,hr]=await Promise.all([
      fetch('/api/portfolio'),
      fetch('/api/auto/status'),
      fetch('/api/trade-history?limit=100')
    ]);
    const port=await pr.json(), auto=await ar.json(), hist=await hr.json();

    // Update portfolio numbers (DOM diffing ‚Äî no flash)
    updatePortfolio(port);

    // Positions ‚Äî only changed cards get updated
    positions=port.positions||[];
    closedTrades=port.recent_trades||[];
    renderPositions(positions, {});
    renderClosed(closedTrades);

    // History ‚Äî only render in active tab
    if(document.getElementById('panel-history').classList.contains('active')){
      renderHistory(hist.trades||[]);
    }

    // AutoTrader status
    if(auto)updateAutoStatus({
      running:auto.running, scan_count:auto.scan_count,
      auto_bets:auto.auto_bets_placed, auto_resolves:auto.auto_resolves,
      daily_spent:auto.daily_spent, next_scan:auto.next_scan_time,
      scan_interval:auto.scan_interval,
    });

    if(!_initDone){
      log('‚úì All data loaded','s');
      loadChart();
      _initDone=true;
    }
  }catch(e){ log('Data update error: '+e.message,'e'); }
}

async function loadOpps(){
  document.getElementById('oppBody').innerHTML='<tr><td colspan="7" class="empty"><span class="spin"></span>Scanning Polymarket CLOB...</td></tr>';
  document.getElementById('oppSpinner').style.display='inline-block';
  try{
    const d=await(await fetch('/api/opportunities')).json();
    renderOpps(d.opportunities||[]);
    log(`‚úì ${d.total||0} opportunities ‚Äî weather:${d.weather_count||0} btc:${d.btc_count||0} metals:${d.metals_count||0}`,'s');
  }catch(e){
    document.getElementById('oppBody').innerHTML='<tr><td colspan="7" class="empty">Error: '+e.message+'</td></tr>';
  }
  document.getElementById('oppSpinner').style.display='none';
}

async function startAuto(){
  const interval=+document.getElementById('cfgInt').value||300;
  const minEdge=+document.getElementById('cfgEdge').value||15;
  scanIntervalSec=interval;
  await fetch('/api/auto/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({scan_interval:interval,min_edge_pct:minEdge})});
  await fetch('/api/auto/start',{method:'POST'});
  log(`‚ñ∂ AutoTrader started ‚Äî interval: ${interval}s, min edge: ${minEdge}%`,'s');
}

async function stopAuto(){
  await fetch('/api/auto/stop',{method:'POST'});
  log('‚ñ† AutoTrader stopped','w');
}

async function scanNow(){
  document.getElementById('scanIcon').innerHTML='<span class="spin"></span>';
  if(ws&&ws.readyState===WebSocket.OPEN){
    ws.send(JSON.stringify({cmd:'scan_now'}));
  }else{
    try{
      const d=await(await fetch('/api/auto/scan-now',{method:'POST'})).json();
      const all=[...(d.weather_opportunities||[]),...(d.btc_opportunities||[]),...(d.metals_opportunities||[])];
      if(all.length)renderOpps(all);
      log(`‚úì ${d.total_opportunities||0} opportunities`,'s');
    }catch(e){log('Scan error: '+e.message,'e');}
    document.getElementById('scanIcon').textContent='‚ü≥';
  }
}

async function resolve(posId, outcome){
  if(!confirm(`Resolve ${posId} ‚Üí ${outcome}?`))return;
  const card=document.getElementById('pc_'+posId);
  if(card)card.classList.add('resolving');
  const r=await fetch('/api/resolve',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({position_id:posId,outcome})});
  const d=await r.json();
  if(d.success){
    const pnl=d.result?.pnl||0;
    if(card){
      card.classList.add('slide-out');
      setTimeout(()=>{ if(card.parentNode)card.remove(); },420);
    }
    log(`${outcome==='YES'?'‚úì':'‚úó'} Resolve: ${posId} ‚Üí ${outcome} | PnL: ${pnl>=0?'+':''}$${pnl.toFixed(2)}`,pnl>=0?'s':'w');
    // Silently update in background ‚Äî no page jitter
    setTimeout(()=>{
      loadInit();         // update portfolio numbers
    }, 500);
  }else{ if(card)card.classList.remove('resolving'); log('Error: '+(d.error||''),'e'); }
}

async function quickBet(oppStr){
  try{
    const o=JSON.parse(oppStr);
    const amt=parseFloat(prompt(`${o.market.substring(0,70)}\n\nBet amount ($)?`,'5'));
    if(!amt||amt<=0)return;
    const price=o.side==='YES'?o.market_price:1-o.market_price;
    const r=await fetch('/api/place-bet',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
      market_id:o.market_id||o.condition_id||'',market_name:o.market,side:o.side,amount:amt,price,edge:o.edge,market_type:o.type
    })});
    const d=await r.json();
    if(d.success){log(`‚úì BET: ${o.side} $${amt} @ ${price.toFixed(3)} | ${o.market.substring(0,40)}`,'s'); setTimeout(loadInit,600); }
    else log('Bet error: '+(d.error||''),'e');
  }catch(e){log('Error: '+e.message,'e');}
}

async function resetSim(){
  if(!confirm('All simulation data will be deleted. Are you sure?'))return;
  await fetch('/api/reset-sim',{method:'POST'});
  dailyStartBal=null;
  try{localStorage.removeItem('polyarb_daily');}catch(e){}
  log('‚ö† Simulation reset','w');
  loadInit();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showTab(name,btn){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('panel-'+name).classList.add('active');
  btn.classList.add('active');
  if(name==='opps')loadOpps();
  if(name==='history')fetch('/api/trade-history?limit=100').then(r=>r.json()).then(d=>renderHistory(d.trades||[]));
  if(name==='chart')loadChart();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function log(msg,level=''){
  const feed=document.getElementById('logFeed');
  const ts=new Date().toLocaleTimeString('en-US');
  const el=document.createElement('div');
  el.className='log-line '+level;
  el.innerHTML=`<span class="log-ts">${ts}</span>${msg}`;
  feed.insertBefore(el,feed.firstChild);
  while(feed.children.length>250)feed.removeChild(feed.lastChild);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
connectWS();

// Reconnect on focus
document.addEventListener('visibilitychange',()=>{
  if(!document.hidden&&(!ws||ws.readyState!==WebSocket.OPEN))connectWS();
});

// Chart auto-refresh every 60s when visible
setInterval(()=>{
  if(document.getElementById('panel-chart').classList.contains('active'))loadChart();
},60000);
</script>
</body>
</html>
