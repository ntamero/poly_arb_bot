<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Polymarket ARB Bot</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0c0f;
    --bg2: #0f1217;
    --bg3: #161b22;
    --border: #21262d;
    --border2: #30363d;
    --text: #e6edf3;
    --text2: #8b949e;
    --text3: #484f58;
    --green: #3fb950;
    --green-dim: #1a4a24;
    --red: #f85149;
    --red-dim: #4a1a1a;
    --yellow: #e3b341;
    --blue: #58a6ff;
    --blue-dim: #0d2948;
    --purple: #bc8cff;
    --accent: #238636;
    --mono: 'IBM Plex Mono', monospace;
    --sans: 'IBM Plex Sans', sans-serif;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: var(--sans); min-height: 100vh; overflow-x: hidden; }

  .topbar {
    background: var(--bg2); border-bottom: 1px solid var(--border);
    padding: 0 20px; display: flex; align-items: center; gap: 12px;
    height: 52px; position: sticky; top: 0; z-index: 100;
  }
  .logo { font-family: var(--mono); font-size: 13px; font-weight: 600; color: var(--text); display: flex; align-items: center; gap: 8px; }
  .logo-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(63,185,80,0.4)}50%{opacity:.7;box-shadow:0 0 0 6px rgba(63,185,80,0)} }
  .spacer { flex: 1; }
  .ws-badge { font-family: var(--mono); font-size: 11px; padding: 3px 8px; border-radius: 4px; border: 1px solid var(--border2); color: var(--text2); background: var(--bg3); display: flex; align-items: center; gap: 5px; }
  .ws-badge .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--text3); transition: background .3s; }
  .ws-badge.connected .dot { background: var(--green); animation: pulse 2s infinite; }
  .ws-badge.error .dot { background: var(--red); }
  .tick { font-family: var(--mono); font-size: 11px; color: var(--text3); }

  .grid { display: grid; grid-template-columns: 270px 1fr; min-height: calc(100vh - 52px); }

  .sidebar { background: var(--bg2); border-right: 1px solid var(--border); padding: 14px; display: flex; flex-direction: column; gap: 10px; position: sticky; top: 52px; height: calc(100vh - 52px); overflow-y: auto; }

  .sl { font-family: var(--mono); font-size: 10px; font-weight: 500; letter-spacing: .1em; color: var(--text3); text-transform: uppercase; margin-bottom: 3px; }

  .card { background: var(--bg3); border: 1px solid var(--border); border-radius: 8px; padding: 12px; }

  .bal-val { font-family: var(--mono); font-size: 24px; font-weight: 600; color: var(--text); letter-spacing: -.02em; transition: color .3s; }
  .bal-lbl { font-size: 11px; color: var(--text2); margin-top: 2px; }
  .bal-meta { display: flex; gap: 10px; margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); }
  .meta { flex: 1; }
  .mv { font-family: var(--mono); font-size: 13px; font-weight: 500; }
  .mv.g { color: var(--green); } .mv.r { color: var(--red); } .mv.y { color: var(--yellow); }
  .mk { font-size: 10px; color: var(--text3); margin-top: 1px; }

  .btc-main { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 6px; }
  .btc-price { font-family: var(--mono); font-size: 17px; font-weight: 600; color: var(--yellow); transition: all .3s; }
  .btc-spread { font-family: var(--mono); font-size: 10px; color: var(--text3); }
  .ex-row { display: flex; justify-content: space-between; padding: 3px 0; border-bottom: 1px solid var(--border); }
  .ex-row:last-child { border-bottom: none; }
  .ex-name { font-family: var(--mono); font-size: 10px; color: var(--text2); text-transform: uppercase; width: 65px; }
  .ex-price { font-family: var(--mono); font-size: 11px; color: var(--text); font-weight: 500; }
  .ex-delta { font-family: var(--mono); font-size: 10px; width: 45px; text-align: right; }

  .auto-hdr { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
  .auto-title { font-family: var(--mono); font-size: 11px; font-weight: 600; }
  .sbadge { font-family: var(--mono); font-size: 10px; padding: 2px 6px; border-radius: 3px; }
  .sbadge.on { background: var(--green-dim); color: var(--green); border: 1px solid var(--green); }
  .sbadge.off { background: var(--bg); color: var(--text3); border: 1px solid var(--border2); }

  .auto-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 8px; }
  .as { background: var(--bg); border-radius: 4px; padding: 5px 7px; }
  .as-val { font-family: var(--mono); font-size: 13px; font-weight: 600; color: var(--blue); }
  .as-key { font-size: 9px; color: var(--text3); margin-top: 1px; }

  .btn-row { display: flex; gap: 5px; margin-bottom: 5px; }
  .btn { flex: 1; padding: 6px; border-radius: 5px; font-family: var(--mono); font-size: 11px; font-weight: 600; border: none; cursor: pointer; transition: all .15s; letter-spacing: .02em; }
  .btn-g { background: var(--accent); color: #fff; }
  .btn-g:hover { background: #2ea043; }
  .btn-r { background: var(--red-dim); color: var(--red); border: 1px solid var(--red); }
  .btn-r:hover { background: #6a1a1a; }
  .btn-b { background: var(--blue-dim); color: var(--blue); border: 1px solid var(--blue); }
  .btn-b:hover { background: #1a3a5c; }
  .btn-d { background: var(--red-dim); color: var(--red); border: 1px solid var(--red); font-size: 10px; }
  .input-row { display: flex; align-items: center; gap: 5px; margin-top: 6px; }
  .il { font-size: 10px; color: var(--text3); white-space: nowrap; }
  .inp { background: var(--bg); border: 1px solid var(--border2); border-radius: 4px; color: var(--text); font-family: var(--mono); font-size: 11px; padding: 3px 7px; width: 70px; }
  .pbar { height: 2px; background: var(--border); border-radius: 1px; margin-top: 7px; overflow: hidden; }
  .pbar-fill { height: 100%; background: var(--blue); border-radius: 1px; transition: width 1s linear; }
  .pbar-lbl { font-family: var(--mono); font-size: 9px; color: var(--text3); margin-top: 2px; }

  .main { padding: 14px; display: flex; flex-direction: column; gap: 14px; }

  .tabs { display: flex; gap: 2px; background: var(--bg2); border: 1px solid var(--border); border-radius: 7px; padding: 3px; }
  .tab { padding: 6px 14px; border-radius: 5px; font-family: var(--mono); font-size: 11px; font-weight: 500; cursor: pointer; color: var(--text2); border: none; background: transparent; transition: all .15s; }
  .tab.active { background: var(--bg3); color: var(--text); border: 1px solid var(--border2); }
  .tab:hover:not(.active) { color: var(--text); }

  .panel { background: var(--bg2); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
  .ph { padding: 9px 14px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; background: var(--bg3); }
  .pt { font-family: var(--mono); font-size: 11px; font-weight: 600; display: flex; align-items: center; gap: 7px; }
  .cnt { font-family: var(--mono); font-size: 10px; padding: 1px 6px; border-radius: 9px; background: var(--border2); color: var(--text2); }

  table { width: 100%; border-collapse: collapse; font-family: var(--mono); font-size: 11px; }
  thead th { padding: 7px 12px; text-align: left; color: var(--text3); font-weight: 500; font-size: 10px; letter-spacing: .08em; text-transform: uppercase; border-bottom: 1px solid var(--border); background: var(--bg3); }
  tbody tr { border-bottom: 1px solid var(--border); transition: background .1s; }
  tbody tr:last-child { border-bottom: none; }
  tbody tr:hover { background: rgba(255,255,255,.03); }
  td { padding: 8px 12px; vertical-align: middle; }
  .cm { max-width: 280px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text); font-size: 11px; }

  .tag { display: inline-block; padding: 1px 6px; border-radius: 3px; font-size: 9px; font-weight: 600; letter-spacing: .05em; text-transform: uppercase; }
  .tag-btc { background: #3d2800; color: var(--yellow); }
  .tag-weather { background: #0d2948; color: var(--blue); }
  .tag-metals { background: #2d1a4a; color: var(--purple); }
  .tag-yes { background: var(--green-dim); color: var(--green); }
  .tag-no { background: var(--red-dim); color: var(--red); }
  .tag-open { background: var(--blue-dim); color: var(--blue); }
  .tag-won { background: var(--green-dim); color: var(--green); }
  .tag-lost { background: var(--red-dim); color: var(--red); }

  .pc { font-family: var(--mono); font-size: 12px; font-weight: 500; }
  .ec { font-family: var(--mono); font-size: 12px; font-weight: 600; }
  .ep { color: var(--green); } .en { color: var(--red); }
  .lp { font-family: var(--mono); font-size: 11px; color: var(--text2); }
  .lp.upd { animation: flash .5s ease; }
  @keyframes flash { 0%{color:var(--yellow)} 100%{color:var(--text2)} }

  .opp-row td:first-child { border-left: 2px solid transparent; }
  .high-edge td:first-child { border-left-color: var(--green); }
  .med-edge td:first-child { border-left-color: var(--yellow); }

  .log-feed { padding: 6px; display: flex; flex-direction: column-reverse; gap: 2px; max-height: 320px; overflow-y: auto; background: var(--bg); font-family: var(--mono); font-size: 10px; }
  .log-e { padding: 3px 7px; border-radius: 3px; color: var(--text2); border-left: 2px solid var(--border2); line-height: 1.5; }
  .log-e.success { border-left-color: var(--green); color: var(--green); }
  .log-e.warning { border-left-color: var(--yellow); color: var(--yellow); }
  .log-e.error { border-left-color: var(--red); color: var(--red); }
  .log-ts { color: var(--text3); margin-right: 7px; }

  .tab-panel { display: none; }
  .tab-panel.active { display: block; }

  .empty { padding: 35px; text-align: center; color: var(--text3); font-family: var(--mono); font-size: 12px; }

  .rbtn { font-family: var(--mono); font-size: 9px; padding: 2px 6px; border-radius: 3px; border: 1px solid var(--border2); background: var(--bg); color: var(--text2); cursor: pointer; margin-right: 2px; transition: all .15s; }
  .rbtn:hover { border-color: var(--blue); color: var(--blue); }

  .scanning { display: inline-block; width: 10px; height: 10px; border: 2px solid var(--border2); border-top-color: var(--blue); border-radius: 50%; animation: spin .7s linear infinite; margin-right: 5px; vertical-align: middle; }
  @keyframes spin { to { transform: rotate(360deg); } }

  ::-webkit-scrollbar { width: 4px; height: 4px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
</head>
<body>

<div class="topbar">
  <div class="logo"><div class="logo-dot"></div>POLY ARB BOT</div>
  <span id="appVersion" style="font-family:var(--mono);font-size:10px;color:var(--text3)">v1.0.0 ¬∑ SIM MODE</span>
  <div class="spacer"></div>
  <span id="lastUpd" style="font-family:var(--mono);font-size:10px;color:var(--text3)">‚Äî</span>
  <div class="ws-badge" id="wsBadge"><div class="dot"></div><span id="wsStatus">CONNECTING</span></div>
  <span class="tick" id="tickCnt">tick 0</span>
</div>

<div class="grid">
  <div class="sidebar">
    <!-- Balance -->
    <div>
      <div class="sl">Portfolio</div>
      <div class="card">
        <div class="bal-val" id="balVal">$0.00</div>
        <div class="bal-lbl">Current Balance</div>
        <div class="bal-meta">
          <div class="meta"><div class="mv" id="pnlVal">$0.00</div><div class="mk">Total PnL</div></div>
          <div class="meta"><div class="mv y" id="posCount">0</div><div class="mk">Open Pos.</div></div>
          <div class="meta"><div class="mv" id="winRate">0%</div><div class="mk">Win Rate</div></div>
        </div>
      </div>
    </div>

    <!-- BTC Ticker -->
    <div>
      <div class="sl">BTC Live Price</div>
      <div class="card">
        <div class="btc-main">
          <div class="btc-price" id="btcAvg">$‚Äî</div>
          <div class="btc-spread" id="btcSpread">spread: ‚Äî</div>
        </div>
        <div id="exPrices"><div class="ex-row"><span class="ex-name">‚Äî</span><span class="ex-price" style="color:var(--text3)">loading...</span></div></div>
      </div>
    </div>

    <!-- AutoTrader -->
    <div>
      <div class="sl">Auto Trader</div>
      <div class="card">
        <div class="auto-hdr">
          <span class="auto-title">Auto Scanner</span>
          <span class="sbadge off" id="autoBadge">STOPPED</span>
        </div>
        <div class="auto-stats">
          <div class="as"><div class="as-val" id="scanCnt">0</div><div class="as-key">Scans</div></div>
          <div class="as"><div class="as-val" id="autoBets">0</div><div class="as-key">Auto Bets</div></div>
          <div class="as"><div class="as-val" id="autoRes">0</div><div class="as-key">Resolve</div></div>
          <div class="as"><div class="as-val" id="dailySpent">$0</div><div class="as-key">Daily</div></div>
        </div>
        <div class="input-row">
          <span class="il">Interval (sec):</span>
          <input class="inp" type="number" id="scanInterval" value="300" min="30">
          <span class="il">Min Edge %:</span>
          <input class="inp" type="number" id="minEdge" value="15" min="1">
        </div>
        <div class="btn-row" style="margin-top:7px">
          <button class="btn btn-g" onclick="startAuto()">‚ñ∂ START</button>
          <button class="btn btn-r" onclick="stopAuto()">‚ñ† STOP</button>
        </div>
        <div class="btn-row">
          <button class="btn btn-b" onclick="scanNow()"><span id="scanIcon">‚ü≥</span> SCAN NOW</button>
          <button class="btn btn-d" style="flex:none;padding:6px 10px" onclick="resetSim()">RESET</button>
        </div>
        <div class="pbar"><div class="pbar-fill" id="scanBar" style="width:0%"></div></div>
        <div class="pbar-lbl" id="nextLbl">‚Äî</div>
      </div>
    </div>
  </div>

  <div class="main">
    <div class="tabs">
      <button class="tab active" onclick="showTab('positions',this)">Positions</button>
      <button class="tab" onclick="showTab('opportunities',this)">Opportunities</button>
      <button class="tab" onclick="showTab('history',this)">History</button>
      <button class="tab" onclick="showTab('logs',this)">Live Log</button>
      <button class="tab" onclick="showTab('chart',this)">üìà PnL Chart</button>
    </div>

    <!-- POSITIONS -->
    <div class="tab-panel active" id="tab-positions">
      <div class="panel">
        <div class="ph">
          <div class="pt">Open Positions <span class="cnt" id="posCnt">0</span></div>
          <span style="font-family:var(--mono);font-size:10px;color:var(--text3)">Live prices update every 3s ¬∑ Resolve with real CLOB data</span>
        </div>
        <table>
          <thead><tr><th>Market</th><th>Type</th><th>Side</th><th>Amount</th><th>Entry</th><th>Live Price</th><th>Unrealized</th><th>Action</th></tr></thead>
          <tbody id="posBody"><tr><td colspan="8" class="empty">No open positions</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- OPPORTUNITIES -->
    <div class="tab-panel" id="tab-opportunities">
      <div class="panel">
        <div class="ph">
          <div class="pt">Arbitrage Opportunities <span class="cnt" id="oppCnt">0</span></div>
          <button class="btn btn-b" style="font-size:10px;padding:5px 12px" onclick="loadOpps()">‚ü≥ Scan</button>
        </div>
        <table>
          <thead><tr><th>Market</th><th>Type</th><th>Real Prob.</th><th>Market Price</th><th>Edge</th><th>Side</th><th>Action</th></tr></thead>
          <tbody id="oppBody"><tr><td colspan="7" class="empty">Click Opportunities tab or start Auto Trader</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- HISTORY -->
    <div class="tab-panel" id="tab-history">
      <div class="panel">
        <div class="ph"><div class="pt">Trade History</div></div>
        <table>
          <thead><tr><th>Time</th><th>Market</th><th>Side</th><th>Amount</th><th>Entry</th><th>Result</th><th>PnL</th></tr></thead>
          <tbody id="histBody"><tr><td colspan="7" class="empty">No trades yet</td></tr></tbody>
        </table>
      </div>
    </div>


    <!-- CHART -->
    <div class="tab-panel" id="tab-chart">
      <div class="panel">
        <div class="ph">
          <div class="pt">Portfolio PnL ‚Äî Time Series</div>
          <div style="display:flex;gap:6px;align-items:center">
            <button class="rbtn" onclick="setChartPeriod('1h')">1h</button>
            <button class="rbtn" onclick="setChartPeriod('6h')">6h</button>
            <button class="rbtn" onclick="setChartPeriod('24h')">24h</button>
            <button class="rbtn" onclick="setChartPeriod('all')">All</button>
            <button class="rbtn" onclick="loadChart()">‚ü≥</button>
          </div>
        </div>
        <div style="padding:16px;background:var(--bg)">
          <canvas id="pnlChart" style="width:100%;height:320px"></canvas>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:12px">
        <div class="panel">
          <div class="ph"><div class="pt">Portfolio Value</div></div>
          <div style="padding:14px;background:var(--bg)">
            <canvas id="portChart" style="width:100%;height:200px"></canvas>
          </div>
        </div>
        <div class="panel">
          <div class="ph"><div class="pt">Realized vs Unrealized PnL</div></div>
          <div style="padding:14px;background:var(--bg)">
            <canvas id="pnlBreakChart" style="width:100%;height:200px"></canvas>
          </div>
        </div>
        <div class="panel">
          <div class="ph"><div class="pt">Win Rate Trend</div></div>
          <div style="padding:14px;background:var(--bg)">
            <canvas id="wrChart" style="width:100%;height:200px"></canvas>
          </div>
        </div>
      </div>
      <div class="panel" style="margin-top:12px">
        <div class="ph"><div class="pt">Live Statistics</div></div>
        <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:1px;background:var(--border)">
          <div style="background:var(--bg3);padding:14px;text-align:center">
            <div class="as-val" id="statBal">‚Äî</div><div class="as-key">Current Balance</div>
          </div>
          <div style="background:var(--bg3);padding:14px;text-align:center">
            <div class="as-val" id="statPortVal">‚Äî</div><div class="as-key">Portfolio Value</div>
          </div>
          <div style="background:var(--bg3);padding:14px;text-align:center">
            <div class="as-val" id="statRealPnl">‚Äî</div><div class="as-key">Realized PnL</div>
          </div>
          <div style="background:var(--bg3);padding:14px;text-align:center">
            <div class="as-val" id="statUnrealPnl">‚Äî</div><div class="as-key">Unrealized PnL</div>
          </div>
          <div style="background:var(--bg3);padding:14px;text-align:center">
            <div class="as-val" id="statOpenPos">‚Äî</div><div class="as-key">Open Positions</div>
          </div>
          <div style="background:var(--bg3);padding:14px;text-align:center">
            <div class="as-val" id="statWR">‚Äî</div><div class="as-key">Win Rate</div>
          </div>
        </div>
      </div>
    </div>

    <!-- LOGS -->
    <div class="tab-panel" id="tab-logs">
      <div class="panel">
        <div class="ph">
          <div class="pt">Live Bot Log</div>
          <button class="rbtn" onclick="document.getElementById('logFeed').innerHTML=''">Clear</button>
        </div>
        <div class="log-feed" id="logFeed">
          <div class="log-e">Waiting for WebSocket connection...</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let ws = null, tick = 0, scanIntervalSec = 300, nextScan = null;

function connectWS() {
  const proto = location.protocol === 'https:' ? 'wss' : 'ws';
  ws = new WebSocket(`${proto}://${location.host}/ws`);

  ws.onopen = () => {
    setWS('connected', 'LIVE');
    log('WebSocket connected', 'success');
    loadInit();
  };

  ws.onmessage = (e) => {
    try { handle(JSON.parse(e.data)); } catch(err) {}
  };

  ws.onclose = () => {
    setWS('error', 'DISCONNECTED');
    log('Connection lost, reconnecting...', 'warning');
    setTimeout(connectWS, 3000);
    startPoll();
  };

  ws.onerror = () => { setWS('error', 'ERROR'); startPoll(); };
}

let pollTimer = null;
function startPoll() {
  if (pollTimer) return;
  pollTimer = setInterval(async () => {
    try {
      const d = await (await fetch('/api/live-prices')).json();
      updateBTC(d.btc || {});
      updatePortfolioBasic(d.portfolio || {});
    } catch(e) {}
  }, 5000);
}

function handle(msg) {
  tick++;
  document.getElementById('tickCnt').textContent = `tick ${tick}`;
  document.getElementById('lastUpd').textContent = new Date().toLocaleTimeString('en-US');

  if (msg.type === 'live_update') {
    const d = msg.data;
    if (d.btc) updateBTC(d.btc);
    if (d.portfolio_full) updatePortfolio(d.portfolio_full);
    if (d.positions !== undefined) updatePositions(d.positions, d.position_prices || {});
    if (d.auto_status) updateAuto(d.auto_status);
    if (d.auto_status?.last_logs) d.auto_status.last_logs.forEach(l => log(l.msg, l.level));
    if (d.auto_status?.last_opportunities?.length) updateOpps(d.auto_status.last_opportunities);
  } else if (msg.type === 'scan_start') {
    log('Scan started...', 'info');
    document.getElementById('scanIcon').innerHTML = '<span class="scanning"></span>';
  } else if (msg.type === 'scan_result') {
    document.getElementById('scanIcon').textContent = '‚ü≥';
    log(`Scan completed: ${msg.data.total_opportunities || 0} opportunities`, 'success');
    const all = [...(msg.data.weather_opportunities||[]), ...(msg.data.btc_opportunities||[]), ...(msg.data.metals_opportunities||[])];
    if (all.length) updateOpps(all);
  }
}

function setWS(state, txt) {
  document.getElementById('wsBadge').className = `ws-badge ${state}`;
  document.getElementById('wsStatus').textContent = txt;
}

function updateBTC(btc) {
  if (!btc || !btc.average) return;
  document.getElementById('btcAvg').textContent = '$' + Math.round(btc.average).toLocaleString('en-US');
  document.getElementById('btcSpread').textContent = `spread: $${Math.round(btc.spread||0).toLocaleString('en-US')}`;
  if (btc.prices && Object.keys(btc.prices).length) {
    const avg = btc.average;
    document.getElementById('exPrices').innerHTML = Object.entries(btc.prices).map(([ex, p]) => {
      const d = avg > 0 ? ((p-avg)/avg*100) : 0;
      const dc = d > 0 ? 'var(--green)' : d < 0 ? 'var(--red)' : 'var(--text3)';
      return `<div class="ex-row">
        <span class="ex-name">${ex}</span>
        <span class="ex-price">$${Math.round(p).toLocaleString('en-US')}</span>
        <span class="ex-delta" style="color:${dc}">${d>=0?'+':''}${d.toFixed(2)}%</span>
      </div>`;
    }).join('');
  }
}

function updatePortfolio(p) {
  if (!p) return;
  document.getElementById('balVal').textContent = '$' + (p.balance||0).toFixed(2);
  const pnl = p.total_pnl || 0;
  const el = document.getElementById('pnlVal');
  el.textContent = (pnl>=0?'+':'') + '$' + pnl.toFixed(2);
  el.className = `mv ${pnl>=0?'g':'r'}`;
  document.getElementById('posCount').textContent = p.open_positions||0;
  const wr = p.win_rate||0;
  const we = document.getElementById('winRate');
  we.textContent = wr.toFixed(1)+'%';
  we.className = `mv ${wr>=50?'g':'r'}`;
  // Also update chart stats panel with portfolio data
  updateStatsFromPortfolio(p);
}

function updatePortfolioBasic(p) {
  if (p.balance !== undefined) document.getElementById('balVal').textContent = '$' + (+p.balance).toFixed(2);
}

function updatePositions(positions, livePrices) {
  const tbody = document.getElementById('posBody');
  document.getElementById('posCnt').textContent = positions.length;
  document.getElementById('posCount').textContent = positions.length;

  if (!positions.length) {
    tbody.innerHTML = '<tr><td colspan="8" class="empty">No open positions</td></tr>';
    return;
  }

  tbody.innerHTML = positions.map(pos => {
    const mid = pos.market_id || '';
    const ld = livePrices[mid] || {};
    const lp = ld.price || 0;
    const upnl = ld.unrealized_pnl;
    const upnlHtml = upnl !== undefined
      ? `<span class="ec ${upnl>=0?'ep':'en'}">${upnl>=0?'+':''}$${upnl.toFixed(3)}</span>`
      : `<span style="color:var(--text3)">‚Äî</span>`;
    const liq = ld.liquid ? '<span style="color:var(--green);font-size:9px;margin-left:3px">‚óèLIQ</span>' : '';

    return `<tr>
      <td class="cm" title="${pos.market}">${pos.market}</td>
      <td><span class="tag tag-${pos.type||'btc'}">${pos.type||'btc'}</span></td>
      <td><span class="tag tag-${pos.side.toLowerCase()}">${pos.side}</span></td>
      <td class="pc">$${(pos.amount||0).toFixed(2)}</td>
      <td class="pc">${(pos.entry_price||0).toFixed(3)}</td>
      <td class="lp" id="lp_${pos.id}">${lp>0?lp.toFixed(4):'<span style="color:var(--text3)">‚Äî</span>'}${liq}</td>
      <td>${upnlHtml}</td>
      <td>
        <button class="rbtn" onclick="resolve('${pos.id}','YES')">YES</button>
        <button class="rbtn" onclick="resolve('${pos.id}','NO')">NO</button>
      </td>
    </tr>`;
  }).join('');
}

function updateAuto(s) {
  const b = document.getElementById('autoBadge');
  b.className = `sbadge ${s.running ? 'on' : 'off'}`;
  b.textContent = s.running ? 'RUNNING' : 'STOPPED';
  document.getElementById('scanCnt').textContent = s.scan_count||0;
  document.getElementById('autoBets').textContent = s.auto_bets||0;
  document.getElementById('autoRes').textContent = s.auto_resolves||0;
  document.getElementById('dailySpent').textContent = '$' + (s.daily_spent||0).toFixed(2);

  if (s.next_scan && s.running) {
    nextScan = new Date(s.next_scan);
    scanIntervalSec = s.scan_interval || scanIntervalSec;
    updateProgress();
  }
}

function updateProgress() {
  if (!nextScan) return;
  const now = Date.now(), next = nextScan.getTime();
  const interval = scanIntervalSec * 1000;
  const elapsed = interval - (next - now);
  const pct = Math.max(0, Math.min(100, elapsed/interval*100));
  document.getElementById('scanBar').style.width = pct + '%';
  const secs = Math.max(0, Math.round((next-now)/1000));
  document.getElementById('nextLbl').textContent = `Next: ${secs}s`;
}
setInterval(updateProgress, 1000);

function updateOpps(opps) {
  document.getElementById('oppCnt').textContent = opps.length;
  if (!opps.length) {
    document.getElementById('oppBody').innerHTML = '<tr><td colspan="7" class="empty">No opportunities found</td></tr>';
    return;
  }
  document.getElementById('oppBody').innerHTML = opps.slice(0,30).map(o => {
    const edge = o.edge||0;
    const ec = edge>0.25?'high-edge':edge>0.15?'med-edge':'';
    const es = edge>=0?`+${(edge*100).toFixed(1)}%`:`${(edge*100).toFixed(1)}%`;
    const rp = o.noaa_prob || o.real_prob || 0;
    return `<tr class="opp-row ${ec}">
      <td class="cm" title="${o.market}">${o.market}</td>
      <td><span class="tag tag-${o.type}">${o.type}</span></td>
      <td class="pc">${(rp*100).toFixed(1)}%</td>
      <td class="pc">${((o.market_price||0)*100).toFixed(1)}%</td>
      <td class="ec ${edge>=0?'ep':'en'}">${es}</td>
      <td><span class="tag tag-${(o.side||'YES').toLowerCase()}">${o.side}</span></td>
      <td><button class="rbtn" onclick='quickBet(${JSON.stringify(JSON.stringify(o))})'>BET</button></td>
    </tr>`;
  }).join('');
}

function log(msg, level='info') {
  const feed = document.getElementById('logFeed');
  const ts = new Date().toLocaleTimeString('en-US');
  const el = document.createElement('div');
  el.className = `log-e ${level}`;
  el.innerHTML = `<span class="log-ts">${ts}</span>${msg}`;
  feed.insertBefore(el, feed.firstChild);
  while (feed.children.length > 200) feed.removeChild(feed.lastChild);
}

function showTab(name, btn) {
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  btn.classList.add('active');
  if (name === 'opportunities') loadOpps();
  if (name === 'history') loadHist();
}

async function loadInit() {
  try {
    const [pr, ar] = await Promise.all([fetch('/api/portfolio'), fetch('/api/auto/status')]);
    const port = await pr.json();
    const auto = await ar.json();
    updatePortfolio(port);
    updatePositions(port.positions||[], {});
    if (auto) updateAuto({
      running: auto.running,
      scan_count: auto.scan_count,
      auto_bets: auto.auto_bets_placed,
      auto_resolves: auto.auto_resolves,
      daily_spent: auto.daily_spent,
      next_scan: auto.next_scan_time,
      scan_interval: auto.scan_interval,
    });
    const hist = await (await fetch('/api/trade-history?limit=100')).json();
    renderHist(hist.trades||[]);
    log('Data loaded', 'success');
  } catch(e) { log('API error: '+e.message, 'error'); }
}

async function loadOpps() {
  document.getElementById('oppBody').innerHTML = '<tr><td colspan="7" class="empty"><span class="scanning"></span>Scanning...</td></tr>';
  try {
    const d = await (await fetch('/api/opportunities')).json();
    updateOpps(d.opportunities||[]);
    log(`${d.total||0} opportunities (${d.weather_count||0} weather, ${d.btc_count||0} BTC, ${d.metals_count||0} metals)`, 'info');
  } catch(e) {
    document.getElementById('oppBody').innerHTML = '<tr><td colspan="7" class="empty">Error: '+e.message+'</td></tr>';
  }
}

async function loadHist() {
  try {
    const d = await (await fetch('/api/trade-history?limit=100')).json();
    renderHist(d.trades||[]);
  } catch(e) {}
}

function renderHist(trades) {
  const tbody = document.getElementById('histBody');
  if (!trades.length) { tbody.innerHTML='<tr><td colspan="7" class="empty">No trades yet</td></tr>'; return; }
  tbody.innerHTML = [...trades].reverse().map(t => {
    const pnl = t.pnl||0;
    const st = t.status||'open';
    return `<tr>
      <td style="font-size:10px;color:var(--text3);white-space:nowrap">${new Date(t.ts).toLocaleString('en-US')}</td>
      <td class="cm" title="${t.market}">${t.market}</td>
      <td><span class="tag tag-${(t.side||'YES').toLowerCase()}">${t.side}</span></td>
      <td class="pc">$${(t.amount||0).toFixed(2)}</td>
      <td class="pc">${(t.entry_price||0).toFixed(3)}</td>
      <td><span class="tag tag-${st}">${st.toUpperCase()}</span></td>
      <td class="ec ${pnl>=0?'ep':'en'}">${pnl?((pnl>0?'+':'')+'$'+pnl.toFixed(2)):'‚Äî'}</td>
    </tr>`;
  }).join('');
}

async function startAuto() {
  const interval = +document.getElementById('scanInterval').value||300;
  const minEdge = +document.getElementById('minEdge').value||15;
  scanIntervalSec = interval;
  await fetch('/api/auto/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({scan_interval:interval,min_edge_pct:minEdge})});
  await fetch('/api/auto/start',{method:'POST'});
  log(`AutoTrader started (${interval}s interval, ${minEdge}% min edge)`, 'success');
}

async function stopAuto() {
  await fetch('/api/auto/stop',{method:'POST'});
  log('AutoTrader stopped', 'warning');
}

async function scanNow() {
  document.getElementById('scanIcon').innerHTML = '<span class="scanning"></span>';
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({cmd:'scan_now'}));
  } else {
    try {
      const d = await (await fetch('/api/auto/scan-now',{method:'POST'})).json();
      document.getElementById('scanIcon').textContent = '‚ü≥';
      log(`Scan: ${d.total_opportunities||0} opportunities`, 'success');
      const all = [...(d.weather_opportunities||[]),...(d.btc_opportunities||[]),...(d.metals_opportunities||[])];
      if(all.length) updateOpps(all);
    } catch(e) { log('Scan error: '+e.message,'error'); document.getElementById('scanIcon').textContent='‚ü≥'; }
  }
}

async function resolve(posId, outcome) {
  if (!confirm(`Resolve ${posId} as ${outcome}?`)) return;
  const r = await fetch('/api/resolve',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({position_id:posId,outcome})});
  const d = await r.json();
  if (d.success) {
    const pnl = d.result.pnl;
    log(`Resolve: ${posId} ‚Üí ${outcome} | PnL: ${pnl>=0?'+':''}$${pnl.toFixed(2)}`, pnl>=0?'success':'warning');
    loadInit();
  } else log('Error: '+(d.error||''),'error');
}

async function quickBet(oppStr) {
  try {
    const o = JSON.parse(oppStr);
    const amt = parseFloat(prompt(`${o.market.substring(0,60)}\n\nHow much $ to bet?`,'5'));
    if (!amt || amt<=0) return;
    const price = o.side==='YES' ? o.market_price : 1-o.market_price;
    const r = await fetch('/api/place-bet',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
      market_id:o.market_id||o.condition_id||'',market_name:o.market,side:o.side,amount:amt,price,edge:o.edge,market_type:o.type
    })});
    const d = await r.json();
    if(d.success) { log(`BET: ${o.side} $${amt} @ ${price.toFixed(3)} | ${o.market.substring(0,40)}`,'success'); loadInit(); }
    else log('Bet error: '+(d.error||''),'error');
  } catch(e) { log('Error: '+e.message,'error'); }
}

async function resetSim() {
  if (!confirm('All simulation data will be deleted!')) return;
  await fetch('/api/reset-sim',{method:'POST'});
  log('Simulation reset','warning');
  loadInit();
}


// ===== STATS PANEL UPDATE (always works, even without chart history) =====

function updateStatsFromPortfolio(p) {
  if (!p) return;
  const bal = p.balance || 0;
  const portVal = p.portfolio_value || bal;
  const totalPnl = p.total_pnl || 0;
  const openPos = p.open_positions || 0;
  const wr = p.win_rate || 0;

  document.getElementById('statBal').textContent = '$' + bal.toFixed(2);
  document.getElementById('statPortVal').textContent = '$' + portVal.toFixed(2);

  const rpEl = document.getElementById('statRealPnl');
  rpEl.textContent = (totalPnl >= 0 ? '+' : '') + '$' + totalPnl.toFixed(2);
  rpEl.style.color = totalPnl >= 0 ? 'var(--green)' : 'var(--red)';

  document.getElementById('statOpenPos').textContent = openPos;

  const wrEl = document.getElementById('statWR');
  wrEl.textContent = wr.toFixed(1) + '%';
  wrEl.style.color = wr >= 50 ? 'var(--green)' : 'var(--red)';
}

function updateUnrealizedPnl(positionPrices) {
  if (!positionPrices) return;
  let totalUnrealized = 0;
  for (const mid in positionPrices) {
    totalUnrealized += positionPrices[mid].unrealized_pnl || 0;
  }
  const upEl = document.getElementById('statUnrealPnl');
  upEl.textContent = (totalUnrealized >= 0 ? '+' : '') + '$' + totalUnrealized.toFixed(2);
  upEl.style.color = totalUnrealized >= 0 ? 'var(--green)' : 'var(--red)';
}


// ===== CHARTS =====
let charts = {};
let chartPeriod = 'all';

const CHART_DEFAULTS = {
  responsive: true,
  maintainAspectRatio: false,
  animation: { duration: 300 },
  plugins: {
    legend: { labels: { color: '#8b949e', font: { family: "'IBM Plex Mono'", size: 11 } } },
    tooltip: {
      backgroundColor: '#161b22',
      borderColor: '#30363d',
      borderWidth: 1,
      titleColor: '#e6edf3',
      bodyColor: '#8b949e',
      titleFont: { family: "'IBM Plex Mono'" },
      bodyFont: { family: "'IBM Plex Mono'" },
    }
  },
  scales: {
    x: {
      ticks: { color: '#484f58', font: { family: "'IBM Plex Mono'", size: 10 }, maxTicksLimit: 8 },
      grid: { color: '#21262d' },
    },
    y: {
      ticks: { color: '#484f58', font: { family: "'IBM Plex Mono'", size: 10 } },
      grid: { color: '#21262d' },
    }
  }
};

function fmtTime(ts) {
  const d = new Date(ts);
  return d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
}

function fmtDate(ts) {
  const d = new Date(ts);
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
}

function destroyChart(id) {
  if (charts[id]) { charts[id].destroy(); delete charts[id]; }
}

async function loadChart() {
  try {
    // Fetch both PnL history and portfolio data in parallel
    const [r, pRes] = await Promise.all([
      fetch(`/api/pnl-history?limit=200&period=${chartPeriod}`),
      fetch('/api/portfolio')
    ]);
    const d = await r.json();
    const portfolio = pRes.ok ? await pRes.json() : null;

    // Always update stats from portfolio (works even with no chart history)
    if (portfolio) {
      updateStatsFromPortfolio(portfolio);
    }

    renderCharts(d);
  } catch(e) {
    log('Chart data load failed: ' + e.message, 'error');
    // Still try to get portfolio data for stats
    try {
      const pRes = await fetch('/api/portfolio');
      if (pRes.ok) updateStatsFromPortfolio(await pRes.json());
    } catch(e2) {}
    renderDemoCharts();
  }
}

function renderCharts(d) {
  const history = d.history || [];
  const initial = d.initial_balance || 100;
  const current = d.current || {};

  // Update stats from PnL history current snapshot (more detailed)
  if (current.balance !== undefined) {
    document.getElementById('statBal').textContent = '$' + current.balance.toFixed(2);
    document.getElementById('statPortVal').textContent = '$' + (current.portfolio_value || 0).toFixed(2);
    const rp = current.realized_pnl || 0;
    const up = current.unrealized_pnl || 0;
    const rpEl = document.getElementById('statRealPnl');
    rpEl.textContent = (rp >= 0 ? '+' : '') + '$' + rp.toFixed(2);
    rpEl.style.color = rp >= 0 ? 'var(--green)' : 'var(--red)';
    const upEl = document.getElementById('statUnrealPnl');
    upEl.textContent = (up >= 0 ? '+' : '') + '$' + up.toFixed(2);
    upEl.style.color = up >= 0 ? 'var(--green)' : 'var(--red)';
    document.getElementById('statOpenPos').textContent = current.open_positions || 0;
    const wr = current.win_rate || 0;
    const wrEl = document.getElementById('statWR');
    wrEl.textContent = wr.toFixed(1) + '%';
    wrEl.style.color = wr >= 50 ? 'var(--green)' : 'var(--red)';
  }

  if (!history.length) {
    renderDemoCharts();
    return;
  }

  const labels = history.map(h => fmtTime(h.ts));

  // --- CHART 1: Total PnL (bar + line) ---
  destroyChart('pnl');
  const pnlCtx = document.getElementById('pnlChart').getContext('2d');
  const totalPnls = history.map(h => +(h.total_pnl || 0).toFixed(4));
  const portVals = history.map(h => +(h.portfolio_value || initial).toFixed(4));

  charts['pnl'] = new Chart(pnlCtx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'Total PnL ($)',
          data: totalPnls,
          borderColor: totalPnls[totalPnls.length-1] >= 0 ? '#3fb950' : '#f85149',
          backgroundColor: (ctx) => {
            const gradient = ctx.chart.ctx.createLinearGradient(0, 0, 0, ctx.chart.height);
            const last = totalPnls[totalPnls.length-1] || 0;
            if (last >= 0) {
              gradient.addColorStop(0, 'rgba(63,185,80,0.25)');
              gradient.addColorStop(1, 'rgba(63,185,80,0.02)');
            } else {
              gradient.addColorStop(0, 'rgba(248,81,73,0.25)');
              gradient.addColorStop(1, 'rgba(248,81,73,0.02)');
            }
            return gradient;
          },
          borderWidth: 2,
          fill: true,
          tension: 0.4,
          pointRadius: history.length > 30 ? 0 : 3,
          pointHoverRadius: 5,
          yAxisID: 'y',
        },
        {
          label: 'Portfolio Value ($)',
          data: portVals,
          borderColor: '#58a6ff',
          backgroundColor: 'transparent',
          borderWidth: 1.5,
          borderDash: [4, 4],
          tension: 0.4,
          pointRadius: 0,
          pointHoverRadius: 4,
          yAxisID: 'y2',
        }
      ]
    },
    options: {
      ...CHART_DEFAULTS,
      scales: {
        x: CHART_DEFAULTS.scales.x,
        y: {
          ...CHART_DEFAULTS.scales.y,
          position: 'left',
          title: { display: true, text: 'PnL ($)', color: '#484f58', font: { size: 10 } },
        },
        y2: {
          ...CHART_DEFAULTS.scales.y,
          position: 'right',
          grid: { drawOnChartArea: false },
          title: { display: true, text: 'Portfolio ($)', color: '#484f58', font: { size: 10 } },
        }
      }
    }
  });

  // --- CHART 2: Portfolio Value ---
  destroyChart('port');
  const portCtx = document.getElementById('portChart').getContext('2d');
  charts['port'] = new Chart(portCtx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Portfolio ($)',
        data: portVals,
        borderColor: '#58a6ff',
        backgroundColor: 'rgba(88,166,255,0.1)',
        borderWidth: 2, fill: true, tension: 0.4,
        pointRadius: 0, pointHoverRadius: 4,
      }, {
        label: 'Initial ($' + initial.toFixed(0) + ')',
        data: history.map(() => initial),
        borderColor: '#484f58',
        backgroundColor: 'transparent',
        borderDash: [6,3], borderWidth: 1,
        pointRadius: 0,
      }]
    },
    options: { ...CHART_DEFAULTS }
  });

  // --- CHART 3: Realized vs Unrealized ---
  destroyChart('pnlBreak');
  const pbCtx = document.getElementById('pnlBreakChart').getContext('2d');
  charts['pnlBreak'] = new Chart(pbCtx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          label: 'Realized PnL',
          data: history.map(h => +(h.realized_pnl || 0).toFixed(4)),
          backgroundColor: 'rgba(63,185,80,0.6)',
          borderColor: '#3fb950', borderWidth: 1,
        },
        {
          label: 'Unrealized PnL',
          data: history.map(h => +(h.unrealized_pnl || 0).toFixed(4)),
          backgroundColor: 'rgba(88,166,255,0.5)',
          borderColor: '#58a6ff', borderWidth: 1,
        }
      ]
    },
    options: { ...CHART_DEFAULTS, scales: {
      x: { ...CHART_DEFAULTS.scales.x, stacked: true },
      y: { ...CHART_DEFAULTS.scales.y, stacked: true }
    }}
  });

  // --- CHART 4: Win Rate ---
  destroyChart('wr');
  const wrCtx = document.getElementById('wrChart').getContext('2d');
  charts['wr'] = new Chart(wrCtx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Win Rate (%)',
        data: history.map(h => +(h.win_rate || 0).toFixed(1)),
        borderColor: '#e3b341',
        backgroundColor: 'rgba(227,179,65,0.1)',
        borderWidth: 2, fill: true, tension: 0.3,
        pointRadius: 0, pointHoverRadius: 4,
      }, {
        label: '50% Threshold',
        data: history.map(() => 50),
        borderColor: '#484f58', borderDash: [4,4],
        borderWidth: 1, pointRadius: 0,
        backgroundColor: 'transparent',
      }]
    },
    options: { ...CHART_DEFAULTS, scales: {
      x: CHART_DEFAULTS.scales.x,
      y: { ...CHART_DEFAULTS.scales.y, min: 0, max: 100 }
    }}
  });
}

function renderDemoCharts() {
  const now = new Date().toLocaleTimeString('en-US');
  const bal = parseFloat(document.getElementById('balVal').textContent.replace('$','')) || 100;
  destroyChart('pnl');
  const ctx = document.getElementById('pnlChart').getContext('2d');
  charts['pnl'] = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [now],
      datasets: [{
        label: 'PnL ($)',
        data: [bal - 100],
        borderColor: '#3fb950',
        backgroundColor: 'rgba(63,185,80,0.1)',
        borderWidth: 2, fill: true,
      }]
    },
    options: {
      ...CHART_DEFAULTS,
      plugins: {
        ...CHART_DEFAULTS.plugins,
        legend: { ...CHART_DEFAULTS.plugins.legend },
        title: {
          display: true,
          text: 'Chart fills automatically as bot runs (snapshot every 30s)',
          color: '#484f58',
          font: { family: "'IBM Plex Mono'", size: 11 }
        }
      }
    }
  });
}

function setChartPeriod(period) {
  chartPeriod = period;
  loadChart();
}

// Load chart when chart tab is opened
const origShowTab = showTab;
showTab = function(name, btn) {
  origShowTab(name, btn);
  if (name === 'chart') loadChart();
};

// Update chart if chart tab is active on live_update
function updateChartIfOpen(d) {
  const chartTab = document.getElementById('tab-chart');
  if (!chartTab || !chartTab.classList.contains('active')) return;
  if (d.auto_status && !d.auto_status.running) return;
  loadChart();
}

// ======= AUTO-REFRESH SYSTEM =======
// Every 15s: portfolio + positions + trade history
// Every 30s: PnL chart

async function autoRefreshData() {
  try {
    // Portfolio data
    const pRes = await fetch('/api/portfolio');
    if (pRes.ok) {
      const pData = await pRes.json();
      updatePortfolio(pData);
    }
    // Auto status
    const aRes = await fetch('/api/auto/status');
    if (aRes.ok) {
      const aData = await aRes.json();
      updateAuto({
        running: aData.running,
        scan_count: aData.scan_count,
        auto_bets: aData.auto_bets_placed,
        auto_resolves: aData.auto_resolves,
        daily_spent: aData.daily_spent,
        next_scan: aData.next_scan_time,
        scan_interval: aData.scan_interval,
      });
    }
    // Trade history
    const tRes = await fetch('/api/trade-history?limit=100');
    if (tRes.ok) {
      const tData = await tRes.json();
      if (tData.trades) updateTradeTable(tData.trades);
    }
    // Live prices for unrealized PnL
    const lRes = await fetch('/api/live-prices');
    if (lRes.ok) {
      const lData = await lRes.json();
      if (lData.positions) updateUnrealizedPnl(lData.positions);
    }
  } catch(e) {
    console.warn('Auto-refresh error:', e);
  }
}

// Update trade table
function updateTradeTable(trades) {
  const tbody = document.getElementById('histBody');
  if (!tbody || !trades.length) return;
  tbody.innerHTML = trades.slice(0, 50).map(t => {
    const sc = t.status === 'won' ? 'win' : t.status === 'lost' ? 'lose' : 'open';
    const pnl = t.pnl || 0;
    const pc = pnl >= 0 ? 'ep' : 'en';
    return `<tr>
      <td class="cm" title="${t.market}">${t.market}</td>
      <td><span class="tag tag-${(t.side||'YES').toLowerCase()}">${t.side}</span></td>
      <td>$${(t.amount||0).toFixed(2)}</td>
      <td>${((t.entry_price||0)*100).toFixed(1)}¬¢</td>
      <td><span class="tag tag-${sc}">${t.status || 'open'}</span></td>
      <td class="${pc}">${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)}</td>
      <td class="ts">${fmtTime(t.resolved_at || t.ts)}</td>
    </tr>`;
  }).join('');
}

// Periodic refresh timers
setInterval(autoRefreshData, 15000);  // 15s data refresh
setInterval(() => {
  loadChart();
}, 30000);  // 30s PnL chart refresh

// Initial data fetch on page load
setTimeout(autoRefreshData, 2000);
setTimeout(loadChart, 3000);

// Fetch version from API
fetch('/api/status').then(r=>r.json()).then(d=>{
  const mode = d.mode === 'simulation' ? 'SIM' : 'LIVE';
  document.getElementById('appVersion').textContent = `v${d.version} ¬∑ ${mode} MODE`;
}).catch(()=>{});

// INIT
connectWS();
document.addEventListener('visibilitychange', () => {
  if (!document.hidden && ws && ws.readyState !== WebSocket.OPEN) connectWS();
  // Refresh immediately when page becomes visible
  if (!document.hidden) {
    autoRefreshData();
    loadChart();
  }
});
</script>
</body>
</html>
